---
title: "Title"
author: "Jefferson Pastu√±a"
date: "2024-04-17"
output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
usethis::git_vaccinate()

```

## Introduction

Introduction...

## Before to start

Before to start...

## Notame workflow

As a first step...

```{r echo=TRUE, message=FALSE}

# Notame package installation
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("antonvsdata/notame", ref = "v0.3.1")

# Notame library call
library(notame)

# Dependency packages installation
install_dependencies

```

Then, a main path and a log system was added to have a record of each process executed.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Main path
ppath <- "../I_guayusa_volatilome/"
# Log system
init_log(log_file = paste0(ppath, "Result/notame_Result/GCMS_log.txt"))

```

Next...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

data <- read_from_excel(file = "Data/Data_to_notame/erah_Feature_List_2Notame.xlsx", sheet = 2, 
                        corner_row = 11, corner_column = "G", 
                        split_by = c("Column", "Ion mode"))

```

Once the data is read, the next step was...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

modes <- construct_metabosets(exprs = data$exprs, 
                              pheno_data = data$pheno_data, 
                              feature_data = data$feature_data,
                              group_col = "Group")


```

## Preprocessing

The first step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Data extraction
mode <- modes$Rtx5MS_EI
# Change 0 value to NA
mode <- mark_nas(mode, value = 0)

```

Then...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Low detection rate
mode <- flag_detection(mode, qc_limit = 10/14, group_limit = 2/3)

```

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Some statistics after low detection algorithm
#visualizations(mode,
#               prefix = paste0(ppath,
#                               "Result/notame_Result/HS_GCMS/Figure/",
#                               "Low_Detection")
#               )

```

The next step...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Drift correction
corrected <- correct_drift(mode)
# Flag low quality features
corrected <- flag_quality(corrected,
                          condition = "RSD_r < 0.3 & D_ratio_r < 0.6")

```

Then we can visualize the data after drift correction.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
corr_bp <- plot_sample_boxplots(corrected,
                                order_by = "QC",
                                fill_by = "QC")
# PCA
corr_pca <- plot_pca(corrected,
                     center = TRUE,
                     shape = "QC",
                     color = "QC")
# Package to plots visualization in a same windows
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("thomasp85/patchwork")
library(patchwork)
# Plot
corr_pca + corr_bp

```

Contaminant...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Removal of contaminants
corrected_no_blank <- flag_contaminants(corrected,
                                        blank_col = "Group",
                                        blank_label = "Blank",
                                        flag_thresh = 0.38,
                                        flag_label = "Contaminant")
# Removal blank group from dataset
corrected_no_blank <- corrected_no_blank[, corrected_no_blank$Group != "Blank"]

# Exporting data to clean identified features
write_to_excel(corrected_no_blank,
               "Result/notame_Result/erah_corrected_no_blank.xlsx")

```

Dta visualization...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Boxplot
no_blank_bp <- plot_sample_boxplots(corrected_no_blank,
                                 order_by = "QC",
                                 fill_by = "QC")
# PCA
no_blank_pca <- plot_pca(corrected_no_blank,
                      center = TRUE,
                      shape = "Light_condition",
                      color = "Light_condition")
# Plot
no_blank_pca + no_blank_bp

```

The next step...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

clustered <- cluster_features(corrected_no_blank,
                              rt_window = 1/100,
                              corr_thresh = 0.95,
                              d_thresh = 0.8,
                              #plotting = TRUE,
                              #prefix = paste0(ppath, "Result/notame_Result/HS_GCMS/Cluster")
                              )
compressed <- compress_clusters(clustered)

```

We can visualize data...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
clust_bp <- plot_sample_boxplots(compressed,
                                 order_by = "QC",
                                 fill_by = "QC")
# PCA
clust_pca <- plot_pca(compressed,
                      center = TRUE,
                      shape = "Factor",
                      color = "Factor")
# Plot
clust_pca + clust_bp

```

Finally the data is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

#save(imputed, file = paste0(ppath, "Result/notame_Result/HS_GCMS/Notame_HS_GC-MS_out.RData"))

```

# PCA plots

Here read this paper: https://doi.org/10.1007%2Fs11306-016-1030-9

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Impute missing values using random forest
# To clean data
set.seed(1010)
imputed <- impute_rf(compressed)
# To all data
imputed <- impute_rf(imputed, all_features = TRUE)

```

We can inspect PCA plot after...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
imp_bp <- plot_sample_boxplots(imputed,
                               order_by = "QC",
                               fill_by = "QC")
# PCA
imp_pca <- plot_pca(imputed,
                    center = TRUE,
                    shape = "Factor",
                    color = "Factor")
# Plot
imp_pca + imp_bp

```

The next step...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Probabilistic quotient normalization
pqn_set <- pqn_normalization(imputed,
                             ref = c("qc", "all"),
                             method = c("median", "mean"),
                             all_features = FALSE)

```

We can inspect PCA plot after...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
pqn_bp <- plot_sample_boxplots(pqn_set,
                               order_by = "Injection_order",
                               fill_by = "QC")
# PCA
pqn_pca <- plot_pca(pqn_set,
                    center = TRUE,
                    shape = "Factor",
                    color = "Factor")
# Plot
pqn_pca + pqn_bp

```

### PCA to see subQC clusters

Droping flagged features...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extract clean data
no_flag <- drop_flagged(pqn_set)
# Extracting feature height table
peak_height <- exprs(no_flag)
# Extracting Phenotipic data
pheno_data <- no_flag@phenoData@data

```

The next step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# "SummarizedExperiment" package installation
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("SummarizedExperiment")
library(SummarizedExperiment)
# Convert feature height table to SummarizedExperiment class
pmp_data <- SummarizedExperiment(assays = peak_height,
                                 colData = pheno_data)
# Package to generalized logarithmic transform
#if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("pmp")
library(pmp)
# Generalised logarithmic transform
glog_set <- glog_transformation (df = pmp_data@assays@data@listData[[1]],
                                 classes = pmp_data$QC,
                                 qc_label = "QC")

```

Preparing data and transposing feature table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table  <- t(glog_set)
# Centering and Scaling features
ei_pca <- prcomp(transp_table, center = TRUE, scale. = TRUE)

```

Plotting PCA results.

Light level PCA plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Library to left_join use
library(dplyr)
# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data )                 # Adding metadata
# PCA plot
ggplot(scores,
       aes(PC1, PC2, shape = Light_in_subQC, color = Light_in_subQC)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (15.49 %)"),
         y=guide_axis(title = "PC2 (13.03 %)")) +
  labs(shape = 'Light condition', color= 'Light condition') +
  theme_classic() +
  theme(legend.position = c(0.1, 0.18),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
# Save plot
#ggsave('Result/GCMS/GCMS_PCA_To_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

Period age level PCA plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data )                 # Adding metadata
# PCA plot
ggplot(scores,
       aes(PC1, PC2, shape = Age_in_subQC, color = Age_in_subQC)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (15.49 %)"),
         y=guide_axis(title = "PC2 (13.03 %)")) +
  labs(shape = 'Period age', color= 'Period age') +
  theme_classic() +
  theme(legend.position = c(0.1, 0.18),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
# Save plot
#ggsave('Result/GCMS/GCMS_PCA_To_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

Location level PCA plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data )                 # Adding metadata
# PCA plot
ggplot(scores,
       aes(PC1, PC2, shape = Location_in_subQC, color = Location_in_subQC)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (15.49 %)"),
         y=guide_axis(title = "PC2 (13.03 %)")) +
  labs(shape = 'Location', color= 'Location') +
  theme_classic() +
  theme(legend.position = c(0.1, 0.18),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
# Save plot
#ggsave('Result/GCMS/GCMS_PCA_To_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

Plotting loading results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings <- ei_pca$rotation %>%           # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with Feature name and Compound column.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Load a metabolite name table
#metab_name <- readxl::read_excel("Data/GCMS_Metabolites.xlsx", 6)
# Creating a new small table of the annotated compounds
#ei_compouds <- left_join(metab_name, loadings)
# Plotting results
ggplot(loadings, aes(PC1, PC2)) + 
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = loadings, size = 1) +
  #ggrepel::geom_label_repel(data = ei_compouds,
                            #aes(label = Metabolite_name),
                            #box.padding = 0.8,
                            #label.padding = 0.3,
                            #label.r = 0.3,
                            #cex = 3.7) +
  guides(x=guide_axis(title = "PC1 (15.49 %)"),
         y=guide_axis(title = "PC2 (13.03 %)")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
# Save plot
#ggsave('Result/GCMS/GCMS_Loadings_to_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```










### PCA to see all sample clusters

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Drop Sub QC
no_subqc <- pqn_set[, pqn_set$Age_in_samples != "Sub_Quality_Control"]
# Extract clean data
no_flag1 <- drop_flagged(no_subqc)
# Extracting feature height table
peak_height1 <- exprs(no_flag1)
# Extracting Phenotipic data
pheno_data1 <- no_flag1@phenoData@data

```

The next step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Convert feature height table to SummarizedExperiment class
pmp_data1 <- SummarizedExperiment(assays = peak_height1,
                                  colData = pheno_data1)
# Generalized logarithmic transform
glog_set1 <- glog_transformation (df = pmp_data1@assays@data@listData[[1]],
                                  classes = pmp_data1$QC,
                                  qc_label = "QC")

```

Preparing data and transposing feature table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table1  <- t(glog_set1)
# Centering and Scaling features
ei_pca1 <- prcomp(transp_table1, center = TRUE, scale. = TRUE)

```

Plotting PCA results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores1 <- ei_pca1$x %>%                 # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data1)                 # Adding metadata
# PCA plot
ggplot(scores1,
       aes(PC1, PC2, shape = Light_in_samples, color = Light_in_samples)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (17.48 %)"),
         y=guide_axis(title = "PC2 (13.68 %)")) +
  labs(shape = 'Light condition', color= 'Light condition') +
  theme_classic() +
  theme(legend.position = c(0.1, 0.18),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
# Save plot
#ggsave('Result/GCMS/GCMS_PCA_To_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

Age level PCA score plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores1 <- ei_pca1$x %>%                 # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data1)                 # Adding metadata
# PCA plot
ggplot(scores1,
       aes(PC1, PC2, shape = Age_in_samples, color = Age_in_samples)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (17.48 %)"),
         y=guide_axis(title = "PC2 (13.68 %)")) +
  labs(shape = 'Period age', color= 'Period age') +
  theme_classic() +
  theme(legend.position = c(0.1, 0.18),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
# Save plot
#ggsave('Result/GCMS/GCMS_PCA_To_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

Location level PCA score plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores1 <- ei_pca1$x %>%                 # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data1)                 # Adding metadata
# PCA plot
ggplot(scores1,
       aes(PC1, PC2, shape = Location_in_samples, color = Location_in_samples)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (17.48 %)"),
         y=guide_axis(title = "PC2 (13.68 %)")) +
  labs(shape = 'Location', color='Location') +
  theme_classic() +
  theme(legend.position = c(0.1, 0.18),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
# Save plot
#ggsave('Result/GCMS/GCMS_PCA_To_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

Plotting loading results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings1 <- ei_pca1$rotation %>%          # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with Feature name and Compound column.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Load a metabolite name table
#metab_name <- readxl::read_excel("Data/GCMS_Metabolites.xlsx", 6)
# Creating a new small table of the annotated compounds
#ei_compouds <- left_join(metab_name, loadings)
# Plotting results
ggplot(loadings1, aes(PC1, PC2)) + 
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = loadings1, size = 1) +
  #ggrepel::geom_label_repel(data = ei_compouds,
                            #aes(label = Metabolite_name),
                            #box.padding = 0.8,
                            #label.padding = 0.3,
                            #label.r = 0.3,
                            #cex = 3.7) +
  guides(x=guide_axis(title = "PC1 (17.48 %)"),
         y=guide_axis(title = "PC2 (13.68 %)")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
# Save plot
#ggsave('Result/GCMS/GCMS_Loadings_to_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```











### PCA of each location

Alto Pano

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting "Alto Pano" (B) data
b_data <- no_subqc[, no_subqc$Location_in_samples != "Alto Tena"]
b_data <- b_data[, b_data$Location_in_samples != "Talag"]
# Extracting clean data
b_data  <- drop_flagged(b_data)
# Extracting feature height table
peak_height2 <- exprs(b_data )
# Extracting Phenotipic data
pheno_data2 <- b_data @phenoData@data

```

The next step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Convert feature height table to SummarizedExperiment class
pmp_data2 <- SummarizedExperiment(assays = peak_height2,
                                  colData = pheno_data2)
# Generalized logarithmic transform
glog_set2 <- glog_transformation (df = pmp_data2@assays@data@listData[[1]],
                                  classes = pmp_data2$QC,
                                  qc_label = "QC")



```

Preparing data and transposing feature table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table2  <- t(glog_set2)
# Centering and Scaling features
ei_pca2 <- prcomp(transp_table2, center = TRUE, scale. = TRUE)

```

Plotting PCA results.

Light level PCA plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores2 <- ei_pca2$x %>%                 # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data2)                 # Adding metadata
# PCA plot
ggplot(scores2,
       aes(PC1, PC2, shape = Age_in_samples, color = Light_in_samples)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (26.15 %)"),
         y=guide_axis(title = "PC2 (18.34 %)")) +
  labs(shape = 'Period age', color='Light condition') +
  theme_classic() +
  theme(legend.position = c(0.1, 0.18),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
# Save plot
#ggsave('Result/GCMS/GCMS_PCA_To_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

Plotting loading results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings2 <- ei_pca2$rotation %>%         # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with Feature name and Compound column.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Load a metabolite name table
#metab_name <- readxl::read_excel("Data/GCMS_Metabolites.xlsx", 6)
# Creating a new small table of the annotated compounds
#ei_compouds <- left_join(metab_name, loadings)
# Plotting results
ggplot(loadings2, aes(PC1, PC2)) + 
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = loadings2, size = 1) +
  #ggrepel::geom_label_repel(data = ei_compouds,
                            #aes(label = Metabolite_name),
                            #box.padding = 0.8,
                            #label.padding = 0.3,
                            #label.r = 0.3,
                            #cex = 3.7) +
  guides(x=guide_axis(title = "PC1 (26.15 %)"),
         y=guide_axis(title = "PC2 (18.34 %)")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
# Save plot
#ggsave('Result/GCMS/GCMS_Loadings_to_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```







Alto Tena

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting "Alto Pano" (B) data
c_data <- no_subqc[, no_subqc$Location_in_samples != "Alto Pano"]
c_data <- c_data[, c_data$Location_in_samples != "Talag"]
# Extracting clean data
c_data  <- drop_flagged(c_data)
# Extracting feature height table
peak_height3 <- exprs(c_data )
# Extracting Phenotipic data
pheno_data3 <- c_data @phenoData@data

```

The next step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Convert feature height table to SummarizedExperiment class
pmp_data3 <- SummarizedExperiment(assays = peak_height3,
                                  colData = pheno_data3)
# Generalized logarithmic transform
glog_set3 <- glog_transformation(df = pmp_data3@assays@data@listData[[1]],
                                 classes = pmp_data3$QC,
                                 qc_label = "QC")

```

Preparing data and transposing feature table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table3  <- t(glog_set3)
# Centering and Scaling features
ei_pca3 <- prcomp(transp_table3, center = TRUE, scale. = TRUE)

```

Plotting PCA results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores3 <- ei_pca3$x %>%                  # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data3)                 # Adding metadata
# PCA plot
ggplot(scores3,
       aes(PC1, PC2, shape = Age_in_samples, color = Light_in_samples)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (22.04 %)"),
         y=guide_axis(title = "PC2 (13.82 %)")) +
  labs(shape = 'Period age', color='Light condition') +
  labs(shape = 'Group', color='Group') +
  theme_classic() +
  theme(legend.position = c(0.1, 0.18),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
# Save plot
#ggsave('Result/GCMS/GCMS_PCA_To_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

Plotting loading results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings3 <- ei_pca3$rotation %>%         # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with Feature name and Compound column.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Load a metabolite name table
#metab_name <- readxl::read_excel("Data/GCMS_Metabolites.xlsx", 6)
# Creating a new small table of the annotated compounds
#ei_compouds <- left_join(metab_name, loadings)
# Plotting results
ggplot(loadings3, aes(PC1, PC2)) + 
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = loadings3, size = 1) +
  #ggrepel::geom_label_repel(data = ei_compouds,
                            #aes(label = Metabolite_name),
                            #box.padding = 0.8,
                            #label.padding = 0.3,
                            #label.r = 0.3,
                            #cex = 3.7) +
  guides(x=guide_axis(title = "PC1 (22.04 %)"),
         y=guide_axis(title = "PC2 (13.82 %)")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
# Save plot
#ggsave('Result/GCMS/GCMS_Loadings_to_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```





Talag

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting "Alto Pano" (B) data
a_data <- no_subqc[, no_subqc$Location_in_samples != "Alto Pano"]
a_data <- a_data[, a_data$Location_in_samples != "Alto Tena"]
# Extracting clean data
a_data  <- drop_flagged(a_data)
# Extracting feature height table
peak_height4 <- exprs(a_data )
# Extracting Phenotipic data
pheno_data4 <- a_data@phenoData@data

```

The next step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Convert feature height table to SummarizedExperiment class
pmp_data4 <- SummarizedExperiment(assays = peak_height4,
                                  colData = pheno_data4)
# Generalized logarithmic transform
glog_set4 <- glog_transformation(df = pmp_data4@assays@data@listData[[1]],
                                 classes = pmp_data4$QC,
                                 qc_label = "QC")

```

Preparing data and transposing feature table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table4  <- t(glog_set4)
# Centering and Scaling features
ei_pca4 <- prcomp(transp_table4, center = TRUE, scale. = TRUE)

```

Plotting PCA results.

Light level PCA plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores4 <- ei_pca4$x %>%                  # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data4)                 # Adding metadata
# PCA plot
ggplot(scores4,
       aes(PC1, PC2, shape = Age_in_samples, color = Light_in_samples)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (24.55 %)"),
         y=guide_axis(title = "PC2 (16.61 %)")) +
  labs(shape = 'Period age', color='Light condition') +
  theme_classic() +
  theme(legend.position = c(0.1, 0.18),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
# Save plot
#ggsave('Result/GCMS/GCMS_PCA_To_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

Plotting loading results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings4 <- ei_pca4$rotation %>%           # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with Feature name and Compound column.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Load a metabolite name table
#metab_name <- readxl::read_excel("Data/GCMS_Metabolites.xlsx", 6)
# Creating a new small table of the annotated compounds
#ei_compouds <- left_join(metab_name, loadings)
# Plotting results
ggplot(loadings4, aes(PC1, PC2)) + 
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = loadings4, size = 1) +
  #ggrepel::geom_label_repel(data = ei_compouds,
                            #aes(label = Metabolite_name),
                            #box.padding = 0.8,
                            #label.padding = 0.3,
                            #label.r = 0.3,
                            #cex = 3.7) +
  guides(x=guide_axis(title = "PC1 (24.55 %)"),
         y=guide_axis(title = "PC2 (16.61 %)")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
# Save plot
#ggsave('Result/GCMS/GCMS_Loadings_to_DQ.pdf', width = 5, height = 4, device='pdf', dpi="print")

```

# Heat map plot

ComplexHeatmap package and dependency installation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# ComplexHeatmap package installation
#if (!requireNamespace("BiocManager", quietly=TRUE))
#    install.packages("BiocManager")
#BiocManager::install("ComplexHeatmap")
library(ComplexHeatmap)

# ColorRamp2 package installation
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("jokergoo/colorRamp2")
library(colorRamp2)

# Cowplot package installation
#install.packages("cowplot")
library(cowplot)

```

Extracting and loaded of identified metabolites abundance.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Metabolite name table without internal standard
metab_name_hm <- readxl::read_excel("Data/GCMS_Metabolites.xlsx", 6)
# Add identified metabolite to "notame" output
add_met <- join_fData(no_flag, metab_name_hm)
# Extracting identified metabolite data
raw_hm <- add_met[!is.na(add_met@featureData@data$Metabolite_name),]
# Extracting feature height table
hm_height <- exprs(raw_hm)
# Extracting sample information
hm_pdata <- raw_hm@phenoData@data
# Extracting feature information
hm_fdata <- raw_hm@featureData@data

```

Scaling, row and top heatmap anotation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

set.seed(1540)
# Logarithmic scale
hm_scl <- log10(hm_height)
rownames(hm_scl) <- hm_fdata$Metabolite_name
colnames(hm_scl) <- hm_pdata$Species
# Metabolite class color
cols_metclass <- c("Benzenoids" = "#800000FF",
                   "Organoheterocyclic compounds" = "#8A9045FF",
                   "Organohalogen compounds" = "#FFA319FF",
                   "Internal Standard" = "#767676FF")
# Add row anotation to HeatMap
hm_row_ann <- rowAnnotation(`Class` = hm_fdata$Superclass,
                            col = list(`Class` = cols_metclass),
                            show_annotation_name = T,
                            show_legend=F)
# Species color
cols_species <- c("A. rigidum" = "#e6550d",
                 "C. guianensis" = "#91cf60",
                 "M. laevis" = "#33d2ff",
                 "P. sagotianum" = "#d957f8")
# Add top anotation to HeatMap
top_info_ann <- HeatmapAnnotation(`Species` = hm_pdata$Species,
                                  col = list(`Species` = cols_species),
                                  show_annotation_name = T,
                                  show_legend=F, 
                                  border = TRUE)
# Color scale
mycol <- colorRamp2(c(1.5, 2.75, 4),
                    c("blue", "white", "red"))
# Heatmap matrix plotting
hm_plot <- Heatmap(hm_scl,
        col = mycol,
        border_gp = grid::gpar(col = "black", lty = 0.05),
        rect_gp = grid::gpar(col = "black", lwd = 0.75),
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "complete",
        top_annotation = top_info_ann,
        column_names_gp = gpar(fontface = "italic"),
        #right_annotation = hm_row_ann,
        show_heatmap_legend = F,
        row_km = 3, column_km = 2)
hm_plot

```

Adding legends to heatmap.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Color scale legend
lgd1 <- Legend(col_fun = mycol,
               title = "log10 abundance",
               at = seq(4),
               direction = "horizontal" )
# Plants species legend
lgd2 <- Legend(labels = gt_render(c("*A. rigidum*",
                                    "*C. guianensis*",
                                    "*M. laevis*",
                                    "*P. sagotianum*")),
               legend_gp = gpar(fill = cols_species),
               title = "Plant species", ncol = 4)
# Metabolite class Legend
#lgd3 <- Legend(labels = c(unique(hm_fdata$Superclass)) ,
#               legend_gp = gpar(fill = cols_metclass), 
#               title = "Metabolite superclass", ncol = 1)

```

ComplexHeatmap plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

set.seed(1540)
# Converting to ggplot
gg_heatmap <- grid.grabExpr(draw(hm_plot))
gg_heatmap <- ggpubr::as_ggplot(gg_heatmap)
# Legends
all_legends <- packLegend(lgd1, lgd2, direction = "horizontal")
gg_legend <- grid.grabExpr(draw(all_legends))
gg_legend_fn <- ggpubr::as_ggplot(gg_legend)
# Heatmap plot
gcms_hm <- plot_grid(gg_legend_fn,
          gg_heatmap, ncol = 1,
          rel_heights = c(0.195, 0.88))
gcms_hm
# Save heatmap plot
#ggsave(filename = "Result/GCMS/GCMS_Heatmap_to_DQ.pdf", plot = gcms_hm,
      #width = 5, height = 3, units = "in", dpi = 300, scale = 1.7)

```

Finish a record.

```{r}

finish_log()

```



