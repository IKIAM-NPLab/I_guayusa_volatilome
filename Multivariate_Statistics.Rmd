---
title: "Effect of age and light on the volatile profile of *Ilex guayusa* leaves - Multivariate statistical analysis"
author: "Jefferson Pastuña"
date: "2024-04-17"
output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
usethis::git_vaccinate()

```

# Introduction

This R Script aims to record the procedure for analyzing the volatile profile of *Ilex guayusa* leaves under different age and light conditions. Each step has a brief explanation, as well as code and graphics.

The workflow used was taken from ["notame": Workflow for Non-Targeted LC–MS Metabolic Profiling](https://doi.org/10.3390/metabo10040135), Which offers a wide variety of functions for perform metabolomic profile analysis.

# Before to start

The "notame" package accepts as input a feature table that can be obtained through software such as MZmine, MS-DIAL, among others. In this case, the feature table was obtained with the help of MZmine. The (*.csv) file exported from MZmine was fixed to get the final feature table input according to the "notame" package format.

Modifications to the raw (*.csv) file can be summarized by adding and renaming columns. The added columns “Column” and “Ion Mode” allow for the analysis of samples with different types of columns and different ionization modes, respectively. Also, the cells corresponding to mass and retention time must be renamed so the "notame" package can detect and process them.

# Notame workflow

The “notame” package and other dependency packages were installed as a first step for the analysis.

```{r echo=TRUE, message=TRUE}

# Notame package installation
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("antonvsdata/notame", ref = "v0.3.1")

# Notame library call
library(notame)

# Dependency packages installation
install_dependencies

```

Then, a primary path and a log system were added to have a record of each process executed.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Main path
ppath <- "../I_guayusa_volatilome/"
# Log system
init_log(log_file = paste0(ppath, "Result/notame_Result/GCMS_log.txt"))

```

Next, the MZmine feature list in "notame" format was loaded.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

data <- read_from_excel(file = "Data/Data_to_notame/MZmine_Feature_List_2Notame.xlsx", sheet = 3, 
                        corner_row = 8, corner_column = "N", 
                        split_by = c("Column", "Ion mode"))

```

Once the data was loaded, the next step was to create a MetaboSet to work with R objects from now on.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

modes <- construct_metabosets(exprs = data$exprs, 
                              pheno_data = data$pheno_data, 
                              feature_data = data$feature_data,
                              group_col = "Group")

```

## Preprocessing

The first step of the preprocessing is to change the features with a value equal to 0 to NA.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Data extraction
mode <- modes$Rtx5MS_EI
# Change 0 value to NA
mode <- mark_nas(mode, value = 0)

```

Then, features with low detection rates are flagged and can be ignored or removed in subsequent analysis. The “notame" package uses two criteria to flag these features: the feature presence in a percentage of QC injections and the feature presence in a percentage within a sample group or class.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Low detection rate
mode <- flag_detection(mode, qc_limit = 10/14, group_limit = 2/3)

```

The following preprocessing step is drift correction, which is applied using smoothed cubic spline regression. In addition, features with low quality (features out of the "RSD_r < 0.3 & D_ratio_r < 0.6" condition) are added to the “Flag” column. The value of RSD < 0.3 for considering a low-quality feature was taken from [Procedures for large-scale metabolic profiling of serum and plasma using gas chromatography and liquid chromatography coupled to mass spectrometry](https://doi.org/10.1038/nprot.2011.335).

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Drift correction
corrected <- correct_drift(mode)
# Flag low quality features
corrected <- flag_quality(corrected,
                          condition = "RSD_r < 0.3 & D_ratio_r < 0.6")

```

Then, we can visualize the data after drift correction.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
corr_bp <- plot_sample_boxplots(corrected,
                                order_by = "QC",
                                fill_by = "QC")
# PCA
corr_pca <- plot_pca(corrected,
                     center = TRUE,
                     shape = "QC",
                     color = "QC")
# Package to plots visualization in a same windows
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("thomasp85/patchwork")
library(patchwork)
# Plot
corr_pca + corr_bp

```

Contaminant peaks based on the process blank sample will be removed.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of contaminants
corrected_no_blank <- flag_contaminants(corrected,
                                        blank_col = "Group",
                                        blank_label = "Blank",
                                        flag_thresh = 0.39,
                                        flag_label = "Contaminant")
# Removal blank group from dataset
corrected_no_blank <- corrected_no_blank[, corrected_no_blank$Group != "Blank"]
pData(corrected_no_blank) <- droplevels(pData(corrected_no_blank))
# Exporting data to clean identified features
#write_to_excel(corrected_no_blank,
#               "Result/notame_Result/MZmine_corrected_no_blank.xlsx")

```

We can inspect data after removing the contaminant features.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Boxplot
no_blank_bp <- plot_sample_boxplots(corrected_no_blank,
                                    order_by = "QC",
                                    fill_by = "QC")
# PCA
no_blank_pca <- plot_pca(corrected_no_blank,
                         center = TRUE,
                         shape = "QC",
                         color = "QC")
# Plot
no_blank_pca + no_blank_bp

```

The next step is feature clustering. This step helps us reduce the number of features of the same molecule that were split due to a 70 eV electron ionization (EI) environment.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Clustering correlated features
clustered <- cluster_features(corrected_no_blank,
                              rt_window = 1/180,
                              corr_thresh = 0.95,
                              d_thresh = 0.80,
                              #plotting = TRUE,
                              #prefix = paste0(ppath, "Result/notame_Result/Cluster/")
                              )
# Extracting representative feature of each cluster
compressed <- compress_clusters(clustered)
# Exporting data to inspect identified features
#write_to_excel(compressed,
#               "Result/notame_Result/MZmine_compressed.xlsx")

```

We can inspect the data using the PCA plot after the clustering algorithm execution.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
clust_bp <- plot_sample_boxplots(compressed,
                                 order_by = "QC",
                                 fill_by = "QC")
# PCA
clust_pca <- plot_pca(compressed,
                      center = TRUE,
                      shape = "QC",
                      color = "QC")
# Plot
clust_pca + clust_bp

```

Finally, the data is ready to be exported and proceed with the statistical analysis.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

#save(compressed, file = paste0(ppath, "Result/notame_Result/notame_out.RData"))

```

# PCA plots

For PCA, we used PQN normalization with Random Forest missing value imputation and glog transformation method, which were taken from [Non-targeted UHPLC-MS metabolomic data processing methods: a comparative investigation of normalisation, missing value imputation, transformation and scaling](https://doi.org/10.1007/s11306-016-1030-9). Also, the previously cited work recommended against using any scaling method. However, we used the auto-scaling method because we found better results.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE, results='hide'}

# Impute missing values using random forest
# To clean data
set.seed(1010)
imputed <- impute_rf(compressed)
# To all data
imputed <- impute_rf(imputed, all_features = TRUE)

```

We can inspect the data with the PCA plot after data imputation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
imp_bp <- plot_sample_boxplots(imputed,
                               order_by = "QC",
                               fill_by = "QC")
# PCA
imp_pca <- plot_pca(imputed,
                    center = TRUE,
                    shape = "QC",
                    color = "QC")
# Plot
imp_pca + imp_bp

```

After data imputation, the final PCA plot requires data normalization by probabilistic quotient normalization (PQN).

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Probabilistic quotient normalization
pqn_set <- pqn_normalization(imputed,
                             ref = c("qc", "all"),
                             method = c("median", "mean"),
                             all_features = FALSE)

```

We can inspect the data with the PCA plot after data normalization.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
pqn_bp <- plot_sample_boxplots(pqn_set,
                               order_by = "QC",
                               fill_by = "QC")
# PCA
pqn_pca <- plot_pca(pqn_set,
                    center = TRUE,
                    shape = "QC",
                    color = "QC")
# Plot
pqn_pca + pqn_bp

```

Finally, the PCA plot requires data transformation by the generalized logarithm (glog) method.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Extract clean data
ppm_noflag <- drop_flagged(pqn_set)
# "SummarizedExperiment" package installation
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("SummarizedExperiment")
library(SummarizedExperiment)
# Convert feature height table to SummarizedExperiment class
pmp_data <- SummarizedExperiment(assays = exprs(ppm_noflag),
                                 colData = ppm_noflag@phenoData@data)
# Package for generalized logarithmic transform
#if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("pmp")
library(pmp)
# Generalised logarithmic transform
glog_exprs <- glog_transformation(df = pmp_data@assays@data@listData[[1]],
                                  classes = pmp_data$QC,
                                  qc_label = "QC")
# Adding glog transformation to notame MetaboSet
glog_set <- ppm_noflag
exprs(glog_set) <- glog_exprs

```

## General PCA

Extracting the data and metadata of notame MetaboSet for PCA plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting feature height table
pca_peakheight <- exprs(glog_set)
# Extracting Phenotipic data
pca_phenodata <- glog_set@phenoData@data

```

Transposing feature table and preparing the PCA data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table  <- t(pca_peakheight)
# Centering features
ei_pca <- prcomp(transp_table, center = TRUE, scale. = FALSE)

```

### Light

Sunlight exposures of the plant PCA plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Library to left_join use
library(dplyr)
# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pca_phenodata)               # Adding metadata
# Change the order of legend column of DataFrame
scores$Light_factor <- factor(scores$Light_factor,
                              levels = c("Light",
                                         "Shade",
                                         "Other factor",
                                         "QC"))
scores$Analysis_group <- factor(scores$Analysis_group,
                                levels = c("Sample",
                                           "Sub_Quality_Control",
                                           "QC"),
                                labels=c("Sample",
                                         "SubQC",
                                         "QC"))
# PCA plot
figure_1a <- ggplot(scores,
                     aes(PC1, PC2, shape = Analysis_group,
                         color = Light_factor)) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#D3D9D9FF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(1, 17, 15)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (18.35 %)"),
         y=guide_axis(title = "PC2 (15.20 %)"),
         shape = guide_legend(order = 2),
         color = guide_legend(order = 1)) +
  labs(shape = 'Analysis group', color= 'Light factor') +
  theme_classic() +
#  theme(legend.position = c(0.88, 0.80),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_1a
# Save plot
#ggsave('Result/notame_Result/Figure_1a.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Age

Plant ages PCA plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pca_phenodata)               # Adding metadata
# Change the order of legend column of DataFrame
scores$Age_factor <- factor(scores$Age_factor,
                 levels = c("Early",
                            "Medium",
                            "Late",
                            "Other factor",
                            "QC"))
scores$Analysis_group <- factor(scores$Analysis_group,
                 levels = c("Sample",
                            "Sub_Quality_Control",
                            "QC"),
                 labels=c("Sample",
                          "SubQC",
                          "QC"))
# PCA plot
figure_1b <- ggplot(scores,
                     aes(PC1, PC2, shape = Analysis_group,
                         color = Age_factor)) +
  scale_color_manual(values=c("#E76BF3",
                              "#00B0F6",
                              "#F8766D",
                              "#D3D9D9FF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(1, 17, 15)) + 
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (18.35 %)"),
         y=guide_axis(title = "PC2 (15.20 %)"),
         shape = guide_legend(order = 2),
         color = guide_legend(order = 1)) +
  labs(shape = 'Analysis group', color= 'Age factor') +
  theme_classic() +
#  theme(legend.position = c(0.88, 0.77),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_1b
# Save plot
#ggsave('Result/notame_Result/Figure_1b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Location

Sample collected location PCA plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pca_phenodata)               # Adding metadata
# Change the order of legend column of DataFrame
scores$Location_factor <- factor(scores$Location_factor,
                 levels = c("Alto Pano",
                            "Alto Tena",
                            "Talag",
                            "Other factor",
                            "QC"))
scores$Analysis_group <- factor(scores$Analysis_group,
                 levels = c("Sample",
                            "Sub_Quality_Control",
                            "QC"),
                 labels=c("Sample",
                          "SubQC",
                          "QC"))
# PCA plot
figure_1c <- ggplot(scores,
                     aes(PC1, PC2, shape = Analysis_group,
                         color = Location_factor)) +
  scale_color_manual(values=c("#B24422FF",
                              "#4F9D4EFF",
                              "#4457A5FF",
                              "#D3D9D9FF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(1, 17, 15)) + 
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (18.35 %)"),
         y=guide_axis(title = "PC2 (15.20 %)")) +
  labs(shape = 'Analysis group', color= 'Location factor') +
  theme_classic() +
#  theme(legend.position = c(0.88, 0.77),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_1c
# Save plot
#ggsave('Result/notame_Result/Figure_1c.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting a loading PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings <- ei_pca$rotation %>%           # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with feature names and a compound column (with identified metabolites).

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Extracting feature identified
metab_data <- glog_set[!is.na(glog_set@featureData@data$Metabolite),]
# Extracting metabolite table
meta_table <- metab_data@featureData@data
# Creating a new small table with the annotated compounds
ei_compouds <- left_join(meta_table, loadings)
# Plotting results
figure_1d <- ggplot(loadings, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = ei_compouds,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = ei_compouds,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.22,
                            label.padding = 0.22,
                            label.r = 0.3,
                            cex = 2.5,
                            max.overlaps = 7,
                            min.segment.length = 0) +
  guides(x=guide_axis(title = "PC1 (18.35 %)"),
         y=guide_axis(title = "PC2 (15.20 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_1d
# Save plot
#ggsave('Result/notame_Result/figure_1d.pdf',
#       width = 20, height = 10.5, device='pdf', dpi="print")

```

## PCA by location

### Alto Pano

Extracting the Alto Pano location data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Drop factor pooled (subQC)
no_subqc <- glog_set[, glog_set$Analysis_group != "Sub_Quality_Control"]
pData(no_subqc) <- droplevels(pData(no_subqc))
# Extracting "Alto Pano" (B) data
b_data <- no_subqc[, no_subqc$Location_factor != "Alto Tena"]
pData(b_data) <- droplevels(pData(b_data))
b_data <- b_data[, b_data$Location_factor != "Talag"]
pData(b_data) <- droplevels(pData(b_data))
# Extracting feature height table
b_peakheight <- exprs(b_data)
# Extracting Phenotipic data
b_phenodata <- b_data@phenoData@data

```

Transposing feature table and preparing the PCA data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
b_transp_table  <- t(b_peakheight)
# Centering and Scaling features
b_pca <- prcomp(b_transp_table, center = TRUE, scale. = FALSE)

```

Plotting the Alto Pano PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
b_scores <- b_pca$x %>%                  # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(b_phenodata)                 # Adding metadata
# Change the order of legend column of DataFrame
b_scores$Age_factor <- factor(b_scores$Age_factor,
                              levels = c("Early",
                                         "Medium",
                                         "Late",
                                         "QC"))
b_scores$Light_factor <- factor(b_scores$Light_factor,
                                levels = c("Light",
                                           "Shade",
                                           "QC"))
# PCA plot
figure_s1a <- ggplot(b_scores,
                     aes(PC1, PC2, shape = Age_factor,
                         color = Light_factor)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (32.40 %)"),
         y=guide_axis(title = "PC2 (21.22 %)")) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(16, 17, 15, 8)) + 
  labs(shape = 'Age factor',
       color='Light factor') +
  theme_classic() +
#  theme(legend.position = c(0.90, 0.65),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_s1a
# Save plot
#ggsave('Result/notame_Result/figure_s1a.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting the Alto Pano loading PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

b_loadings <- b_pca$rotation %>%          # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with feature names and a compound column (with identified metabolites).

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table with the annotated compounds
b_compouds <- left_join(meta_table, b_loadings)
# Plotting results
figure_s1d <- ggplot(b_loadings, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = b_compouds,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = b_compouds,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 7) +
  guides(x=guide_axis(title = "PC1 (32.40 %)"),
         y=guide_axis(title = "PC2 (21.22 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_s1d
# Save plot
#ggsave('Result/notame_Result/figure_s1d.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Alto Tena

Extracting the Alto Tena location data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting "Alto Tena" (C) data
c_data <- no_subqc[, no_subqc$Location_factor != "Alto Pano"]
pData(c_data) <- droplevels(pData(c_data))
c_data <- c_data[, c_data$Location_factor != "Talag"]
pData(c_data) <- droplevels(pData(c_data))
# Extracting feature height table
c_peakheight <- exprs(c_data )
# Extracting Phenotipic data
c_phenodata <- c_data@phenoData@data

```

Transposing feature table and preparing the PCA data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
c_transptable  <- t(c_peakheight)
# Centering and Scaling features
c_pca <- prcomp(c_transptable, center = TRUE, scale. = FALSE)

```

Plotting the Alto Tena PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
c_scores <- c_pca$x %>%                  # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(c_phenodata)                 # Adding metadata
# Change the order of legend column of DataFrame
c_scores$Age_factor <- factor(c_scores$Age_factor,
                              levels = c("Early",
                                         "Medium",
                                         "Late",
                                         "QC"))
c_scores$Light_factor <- factor(c_scores$Light_factor,
                                levels = c("Light",
                                           "Shade",
                                           "QC"))
# PCA plot
figure_s1b <- ggplot(c_scores,
                    aes(PC1, PC2, shape = Age_factor,
                        color = Light_factor)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (24.53 %)"),
         y=guide_axis(title = "PC2 (16.96 %)")) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(16, 17, 15, 8)) + 
  labs(shape = 'Age factor',
       color = 'Light factor') +
  theme_classic() +
#  theme(legend.position = c(0.08, 0.65),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_s1b
# Save plot
#ggsave('Result/notame_Result/figure_s1b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting the Alto Tena loading PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

c_loadings <- c_pca$rotation %>%          # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with feature names and a compound column (with identified metabolites).

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table of the annotated compounds
c_compouds <- left_join(meta_table, c_loadings)
# Plotting results
figure_s1e <- ggplot(c_loadings, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = c_compouds,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = c_compouds,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 7) +
  guides(x=guide_axis(title = "PC1 (24.53 %)"),
         y=guide_axis(title = "PC2 (16.96 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_s1e
# Save plot
#ggsave('Result/notame_Result/figure_s1e.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Talag

Extracting the Talag location data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting "Talag" (A) data
a_data <- no_subqc[, no_subqc$Location_factor != "Alto Pano"]
pData(a_data) <- droplevels(pData(a_data))
a_data <- a_data[, a_data$Location_factor != "Alto Tena"]
pData(a_data) <- droplevels(pData(a_data))
# Extracting feature height table
a_peakheight <- exprs(a_data )
# Extracting Phenotipic data
a_phenodata <- a_data@phenoData@data

```

Transposing feature table and preparing the PCA data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
a_transptable  <- t(a_peakheight)
# Centering and Scaling features
a_pca <- prcomp(a_transptable, center = TRUE, scale. = FALSE)

```

Plotting the Talag PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
a_scores <- a_pca$x %>%                 # Get PC coordinates
  data.frame %>%                        # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%   # Create a new column with the sample names
  left_join(a_phenodata)                # Adding metadata
# Change the order of legend column of DataFrame
a_scores$Age_factor <- factor(a_scores$Age_factor,
                              levels = c("Early",
                                         "Medium",
                                         "Late",
                                         "QC"))
a_scores$Light_factor <- factor(a_scores$Light_factor,
                               levels = c("Light",
                                          "Shade",
                                          "QC"))
# PCA plot
figure_s1c <- ggplot(a_scores,
                    aes(PC1, PC2, shape = Age_factor,
                        color = Light_factor)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (31.23 %)"),
         y=guide_axis(title = "PC2 (21.11 %)")) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(16, 17, 15, 8)) + 
  labs(shape = 'Age factor',
       color = 'Light factor') +
  theme_classic() +
#  theme(legend.position = c(1.08, 0.65),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_s1c
# Save plot
#ggsave('Result/notame_Result/figure_s1c.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting the Talag loading PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

a_loadings <- a_pca$rotation %>%          # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with feature names and a compound column (with identified metabolites).

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table of the annotated compounds
a_compouds <- left_join(meta_table, a_loadings)
# Plotting results
figure_s1f <- ggplot(a_loadings, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = a_compouds,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = a_compouds,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 7) +
  guides(x=guide_axis(title = "PC1 (31.23 %)"),
         y=guide_axis(title = "PC2 (21.11 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_s1f
# Save plot
#ggsave('Result/notame_Result/figure_s1f.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

# Heatmap plot

Only the annotated features were used to visualize the heatmap plot better. Also, the PCA result showed more clear separation of the levels in the SubQC than individual samples; for this reason, the SubQC data was used in the heatmap analysis. For this, the ComplexHeatmap package will be used.

ComplexHeatmap package and other dependency package installation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# ComplexHeatmap package installation
#if (!requireNamespace("BiocManager", quietly=TRUE))
#    install.packages("BiocManager")
#BiocManager::install("ComplexHeatmap")
library(ComplexHeatmap)

# colorRamp2 package installation
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("jokergoo/colorRamp2")
library(colorRamp2)

# cowplot package installation
#install.packages("cowplot")
library(cowplot)

# mdatools package installation
#install_github('svkucheryavski/mdatools')
library(mdatools)

# ClassyFire package installation
#remotes::install_github('aberHRML/classyfireR')
library(classyfireR)

```

The metabolites were classified using the [ClassyFireR](https://doi.org/10.1186/s13321-016-0174-y) to add these metabolite classifications to the heatmap plot.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# InChI key of the metabolites you want to classify
InChI_Keys <- c(Benzeneacetaldehyde = "DTUQWGWMVIHBKE-UHFFFAOYSA-N")
# Get classification
Classification_List <- purrr::map(InChI_Keys, get_classification)
Classification_List

```

## Heatmap of age

Scaling by  Auto-Scaling method and age factor data extraction.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}





# Convert feature height table to SummarizedExperiment class
hm_pmp <- SummarizedExperiment(assays = pca_peakheight,
                               colData = pca_phenodata)
# Generalised logarithmic transform
hm_glog <- glog_transformation(df = hm_pmp@assays@data@listData[[1]],
                               classes = hm_pmp$QC,
                               qc_label = "QC")



# Scaling by autoscaling method
hm_scl <- scale(t(hm_glog), center = TRUE, scale = TRUE)
hm_scl <- t(hm_scl)



# Adding autoscaling data to notame MetaboSet
hm_scl_set <- no_flag
exprs(hm_scl_set) <- hm_scl
# Drop QC
hm_no_qc <- drop_qcs(hm_scl_set)
# Drop samples
hm_no_sample <- hm_no_qc[, hm_no_qc$Analysis_group != "Sample"]
pData(hm_no_sample) <- droplevels(pData(hm_no_sample))
# Extracting levels of age factor
hm_age <- hm_no_sample[, hm_no_sample$Age_factor != "Other factor"]
pData(hm_age) <- droplevels(pData(hm_age))
# Extracting identified metabolites
hm_age_set <- hm_age[!is.na(hm_age@featureData@data$Metabolite),]
# Adding tukey test result
hm_age_set <- join_fData(hm_age_set, hm_tk_table)

```

Row and top heatmap annotation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 9, fig.height = 15}

set.seed(2571)
# Extracting feature height table
hm_height <- exprs(hm_age_set)
# Extracting sample information
hm_pdata <- hm_age_set@phenoData@data
# Extracting feature information
hm_fdata <- hm_age_set@featureData@data
# Adding row and column name
rownames(hm_height) <- hm_fdata$Metabolite
colnames(hm_height) <- hm_pdata$Group
# Metabolite superclass color
cols_metclass <- c("Organic oxygen compounds" = "#C8876EFF",
                   "Benzenoids" = "#2F533CFF",
                   "Phenylpropanoids and polyketides" = "#63764EFF",
                   "Organoheterocyclic compounds" = "#A87735FF",
                   "Lipids and lipid-like molecules" = "#F3C571FF",
                   "Organic acids and derivatives" = "#EEB043FF",
                   "Hydrocarbons" = "#E0D2B5FF")
# Add row anotation to HeatMap
hm_row_ann <- rowAnnotation(`Superclass` = hm_fdata$classyfireR_Superclass,
                            `Tukey test 2` = anno_text(hm_fdata$Late,
                                                       location = 0.5,
                                                       just = "center",
                                                       gp = gpar(fill = "#F8766D",
                                                                 col = "#666666"),
                                                       show_name = TRUE),
                            `Tukey test 1` = anno_text(hm_fdata$Medium,
                                                       location = 0.5,
                                                       just = "center",
                                                       gp = gpar(fill = "#00B0F6",
                                                                 col = "#666666"),
                                                       show_name = TRUE),
                            `Tukey test 0` = anno_text(hm_fdata$Early,
                                                       location = 0.5,
                                                       just = "center",
                                                       gp = gpar(fill = "#E76BF3",
                                                                 col = "#666666"),
                                                       show_name = TRUE),
                            col = list(`Superclass` = cols_metclass),
                            show_annotation_name = T,
                            show_legend = F)
# Factor levels color
cols_levels <- c("Shade" = "#32373AFF",
                 "Early" = "#E76BF3",
                 "Light" = "#F5BC5CFF",
                 "Late" = "#F8766D",
                 "Talag" = "#4457A5FF",
                 "Medium" = "#00B0F6",
                 "Alto Tena" = "#4F9D4EFF",
                 "Alto Pano" = "#B24422FF")
cols_light <- c("Light" = "#F5BC5CFF",
                "Shade" = "#32373AFF")
cols_age <- c("Early" = "#E76BF3",
              "Medium" = "#00B0F6",
              "Late" = "#F8766D")
cols_location <- c("Alto Pano" = "#B24422FF",
                   "Alto Tena" = "#4F9D4EFF",
                   "Talag" = "#4457A5FF")
# Add top anotation to HeatMap
top_info_ann <- HeatmapAnnotation(`Age factor` = hm_pdata$Group,
                                  col = list(`Age factor` = cols_levels),
                                  show_annotation_name = T,
                                  show_legend=F, 
                                  border = TRUE)
# Color scale
mycol <- colorRamp2(c(-2, 0, 2),
                    c("blue", "white", "red"))
# Heatmap matrix plotting
hm_plot <- Heatmap(hm_height,
                   col = mycol,
                   border_gp = grid::gpar(col = "black", lty = 0.05),
                   rect_gp = grid::gpar(col = "black", lwd = 0.75),
                   clustering_distance_columns = "euclidean",
                   clustering_method_columns = "complete",
                   top_annotation = top_info_ann,
                   right_annotation = hm_row_ann,
                   row_names_max_width = unit(10, "cm"),
                   show_heatmap_legend = FALSE,
                   row_km = 3, column_km = 2,
                   row_title = c("a", "b", "c"))
hm_plot

```

Adding legends to heatmap.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Color scale legend
lgd1 <- Legend(col_fun = mycol,
               title = "glog abundance",
               direction = "horizontal" )
# Factor levels legend
lgd2 <- Legend(labels = c("Light",
                          "Shade"),
               legend_gp = gpar(fill = cols_light),
               title = "Light level", ncol = 1)
lgd3 <- Legend(labels = c("Early (0)",
                          "Medium (1)",
                          "Late (2)"),
               legend_gp = gpar(fill = cols_age),
               title = "Age level", ncol = 1)
lgd4 <- Legend(labels = c("Alto Pano",
                          "Alto Tena",
                          "Talag"),
               legend_gp = gpar(fill = cols_location),
               title = "Location level", ncol = 1)
# Metabolite class Legend
lgd5 <- Legend(labels = c(unique(hm_fdata$classyfireR_Superclass)),
               legend_gp = gpar(fill = cols_metclass),
               title = "Metabolite superclass", ncol = 3)

```

Heatmap plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 9, fig.height = 15}

set.seed(2571)
# Converting to ggplot
gg_heatmap <- grid.grabExpr(draw(hm_plot))
gg_heatmap <- ggpubr::as_ggplot(gg_heatmap)
# Legends
all_legends <- packLegend(lgd1,
                          #lgd2,
                          lgd3,
                          #lgd4,
                          lgd5,
                          direction = "horizontal")
gg_legend <- grid.grabExpr(draw(all_legends))
gg_legend_fn <- ggpubr::as_ggplot(gg_legend)
# Heatmap plot
gcms_hm <- plot_grid(gg_legend_fn,
                     gg_heatmap, ncol = 1,
                     rel_heights = c(0.045, 0.880))
gcms_hm
# Save heatmap plot
#ggsave(filename = "Result/notame_Result/Figure_2a.pdf", plot = gcms_hm,
#       width = 7, height = 10, units = "in", dpi = 300, scale = 1.7)
#ggsave(filename = "Result/notame_Result/Figure_2a.png", plot = gcms_hm,
#       width = 7, height = 10, units = "in", dpi = 300, scale = 1.7)

```

## Heatmap of sample

Extracting sample data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Drop subQC
hm1_no_subqc <- hm_no_qc[, hm_no_qc$Analysis_group != "Sub_Quality_Control"]

```

Scaling, row and top heatmap anotation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

set.seed(2571)
# Extracting feature height table
hm1_height <- exprs(hm1_no_subqc)
# Extracting sample information
hm1_pdata <- hm1_no_subqc@phenoData@data
# Adding row and column name
rownames(hm1_height) <- hm_fdata$Metabolite
colnames(hm1_height) <- hm1_pdata$Group
# Factor levels color
cols_light <- c("Light" = "#F5BC5CFF",
                "Shade" = "#32373AFF")
cols_age <- c("Early" = "#E76BF3",
              "Medium" = "#00B0F6",
              "Late" = "#F8766D")
cols_location <- c("Alto Pano" = "#B24422FF",
                   "Alto Tena" = "#4F9D4EFF",
                   "Talag" = "#4457A5FF")
# Add top anotation to HeatMap
top_info_ann1 <- HeatmapAnnotation(`Light level` = hm1_pdata$Light_factor,
                                   `Age level` = hm1_pdata$Age_factor,
                                   `Location level` = hm1_pdata$Location_factor,
                                   col = list(`Light level` = cols_light,
                                              `Age level` = cols_age,
                                              `Location level` = cols_location),
                                   show_annotation_name = T,
                                   show_legend=F,
                                   border = TRUE)
# Color scale
mycol1 <- colorRamp2(c(-4, 0, 4),
                     c("blue", "white", "red"))
# Heatmap matrix plotting
hm1_plot <- Heatmap(hm1_height,
                    col = mycol1,
                    border_gp = grid::gpar(col = "black", lty = 0.05),
                    rect_gp = grid::gpar(col = "black", lwd = 0.75),
                    clustering_distance_columns = "euclidean",
                    clustering_method_columns = "complete",
                    top_annotation = top_info_ann1,
                    right_annotation = hm_row_ann,
                    row_names_max_width = unit(10, "cm"),
                    show_heatmap_legend = FALSE,
                    row_km = 3, column_km = 3)
hm1_plot

```

Adding legends to heatmap.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Color scale legend
lgd1_1hm <- Legend(col_fun = mycol1,
                   title = "glog abundance",
                   direction = "horizontal" )

```

ComplexHeatmap plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

set.seed(2548)
# Converting to ggplot
gg_heatmap1 <- grid.grabExpr(draw(hm1_plot))
gg_heatmap1 <- ggpubr::as_ggplot(gg_heatmap1)
# Legends
all_legends1 <- packLegend(lgd1_1hm,
                           lgd2,
                           lgd3, 
                           lgd4, 
                           lgd5,
                           direction = "horizontal")
gg_legend1 <- grid.grabExpr(draw(all_legends1))
gg_legend_fn1 <- ggpubr::as_ggplot(gg_legend1)
# Heatmap plot
gcms_hm1 <- plot_grid(gg_legend_fn1,
                     gg_heatmap1, ncol = 1,
                     rel_heights = c(0.045, 0.880))
gcms_hm1
# Save heatmap plot
ggsave(filename = "Result/notame_Result/Figure_S4.pdf", plot = gcms_hm1,
       width = 8, height = 10, units = "in", dpi = 300, scale = 1.7)
ggsave(filename = "Result/notame_Result/Figure_s4.png", plot = gcms_hm1,
       width = 8, height = 10, units = "in", dpi = 300, scale = 1.7)

```

# Exporting plot

## General PCA

Merge of score and loading plots of PCA analysis.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Library loading
library(gridExtra)
# Figure matrix
figure_1 <- arrangeGrob(figure_1a,
                        figure_1b,
                        figure_1c,
                        figure_1d,
                        layout_matrix = rbind(c(1, 2, 3),
                                              c(4, 4, 4),
                                              c(4, 4, 4)))
# Adding label to the figures
figure_one <- ggpubr::as_ggplot(figure_1) +
  draw_plot_label(label = LETTERS[1:4],
                  x = c(0, 0.332, 0.665, 0),
                  y = c(.99, .99, .99, .656))
# Exporting (*.pdf) file
ggsave(filename = "Result/notame_Result/figure_1_glog.pdf", plot = figure_one,
      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.png) file
ggsave(filename = "Result/notame_Result/figure_1_glog.png", plot = figure_one,
      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_1_glog.jpg", plot = figure_one,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)

```

PCA score plots of different factors.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Figure matrix
figure_1_pca <- arrangeGrob(figure_1a,
                            figure_1b,
                            figure_1c,
                            layout_matrix = rbind(c(1, 2, 3)))
# Adding label to the figures
figure_one_pca <- ggpubr::as_ggplot(figure_1_pca) +
  draw_plot_label(label = LETTERS[1:3],
                  x = c(0, 0.332, 0.665),
                  y = c(.99, .99, .99))
# Exporting (*.pdf) file
#ggsave(filename = "Result/notame_Result/figure_1_glog_pca.pdf",
#       plot = figure_one_pca, width = 175, height = 45, units = "mm",
#       dpi = 300, scale = 2.5)
# Exporting (*.png) file
#ggsave(filename = "Result/notame_Result/figure_1_glog_pca.png",
#       plot = figure_one_pca, width = 175, height = 45, units = "mm",
#       dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_1_glog_pca.jpg",
#       plot = figure_one_pca, width = 175, height = 45, units = "mm",
#       dpi = 300, scale = 2.5)

```

## PCA by location

### Alto Pano

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Figure matrix
figure_s1 <- arrangeGrob(figure_s1a,
                         figure_s1b,
                         figure_s1c,
                         figure_s1d,
                         layout_matrix = rbind(c(1, 2, 3),
                                               c(4, 4, 4),
                                               c(4, 4, 4)))
# Adding label to the figures
figure_sone <- ggpubr::as_ggplot(figure_s1) +
  draw_plot_label(label = LETTERS[1:4],
                  x = c(0, 0.332, 0.665, 0),
                  y = c(.99, .99, .99, .656))
# Exporting (*.pdf) file
#ggsave(filename = "Result/notame_Result/figure_s1.pdf", plot = figure_sone,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.png) file
#ggsave(filename = "Result/notame_Result/figure_s1.png", plot = figure_sone,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_s1.jpg", plot = figure_sone,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)

```

### Alto Tena

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Figure matrix
figure_s2 <- arrangeGrob(figure_s1a,
                         figure_s1b,
                         figure_s1c,
                         figure_s1e,
                         layout_matrix = rbind(c(1, 2, 3),
                                               c(4, 4, 4),
                                               c(4, 4, 4)))
# Adding label to the figures
figure_stwo <- ggpubr::as_ggplot(figure_s2) +
  draw_plot_label(label = LETTERS[1:4],
                  x = c(0, 0.332, 0.665, 0),
                  y = c(.99, .99, .99, .656))
# Exporting (*.pdf) file
#ggsave(filename = "Result/notame_Result/figure_s2.pdf", plot = figure_stwo,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.png) file
#ggsave(filename = "Result/notame_Result/figure_s2.png", plot = figure_stwo,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_s2.jpg", plot = figure_stwo,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)

```

### Talag

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Figure matrix
figure_s3 <- arrangeGrob(figure_s1a,
                         figure_s1b,
                         figure_s1c,
                         figure_s1f,
                         layout_matrix = rbind(c(1, 2, 3),
                                               c(4, 4, 4),
                                               c(4, 4, 4)))
# Adding label to the figures
figure_sthree <- ggpubr::as_ggplot(figure_s3) +
  draw_plot_label(label = LETTERS[1:4],
                  x = c(0, 0.332, 0.665, 0),
                  y = c(.99, .99, .99, .656))
# Exporting (*.pdf) file
#ggsave(filename = "Result/notame_Result/figure_s3.pdf", plot = figure_sthree,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.png) file
#ggsave(filename = "Result/notame_Result/figure_s3.png", plot = figure_sthree,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_s3.jpg", plot = figure_sthree,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)

```

## Age plots

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Figure matrix
figure_2 <- arrangeGrob(gcms_hm,
                        vc_plot,
                        layout_matrix = rbind(c(1, 2)))
# Adding label to the figures
figure_two <- ggpubr::as_ggplot(figure_2) +
  draw_plot_label(label = LETTERS[1:2],
                  x = c(0, 0.5),
                  y = c(.99, .99))
# Exporting (*.pdf) file
ggsave(filename = "Result/notame_Result/figure_2.pdf", plot = figure_two,
      width = 175, height = 155, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.png) file
ggsave(filename = "Result/notame_Result/figure_2.png", plot = figure_two,
      width = 175, height = 155, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_2.jpg", plot = figure_two,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)

```




Finish a record.

```{r}

finish_log()

```



