---
title: "Title"
author: "Jefferson Pastu√±a"
date: "2024-04-17"
output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
usethis::git_vaccinate()

```

# Introduction

Introduction...

# Before to start

Before to start...

# Notame workflow

As a first step...

```{r echo=TRUE, message=FALSE}

# Notame package installation
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("antonvsdata/notame", ref = "v0.3.1")

# Notame library call
library(notame)

# Dependency packages installation
install_dependencies

```

Then, a main path and a log system was added to have a record of each process executed.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Main path
ppath <- "../I_guayusa_volatilome/"
# Log system
init_log(log_file = paste0(ppath, "Result/notame_Result/GCMS_log.txt"))

```

Next...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

data <- read_from_excel(file = "Data/Data_to_notame/MZmine_Feature_List_2Notame.xlsx", sheet = 2, 
                        corner_row = 8, corner_column = "N", 
                        split_by = c("Column", "Ion mode"))

```

Once the data is read, the next step was...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

modes <- construct_metabosets(exprs = data$exprs, 
                              pheno_data = data$pheno_data, 
                              feature_data = data$feature_data,
                              group_col = "Group")


```

## Preprocessing

The first step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Data extraction
mode <- modes$Rtx5MS_EI
# Change 0 value to NA
mode <- mark_nas(mode, value = 0)

```

Then...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Low detection rate
mode <- flag_detection(mode, qc_limit = 10/14, group_limit = 2/3)

```

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Some statistics after low detection algorithm
#visualizations(mode,
#               prefix = paste0(ppath,
#                               "Result/notame_Result/HS_GCMS/Figure/",
#                               "Low_Detection")
#               )

```

The next step...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Drift correction
corrected <- correct_drift(mode)
# Flag low quality features
corrected <- flag_quality(corrected,
                          condition = "RSD_r < 0.3 & D_ratio_r < 0.6")

```

Then we can visualize the data after drift correction.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
corr_bp <- plot_sample_boxplots(corrected,
                                order_by = "QC",
                                fill_by = "QC")
# PCA
corr_pca <- plot_pca(corrected,
                     center = TRUE,
                     shape = "QC",
                     color = "QC")
# Package to plots visualization in a same windows
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("thomasp85/patchwork")
library(patchwork)
# Plot
corr_pca + corr_bp

```

Contaminant...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Removal of contaminants
corrected_no_blank <- flag_contaminants(corrected,
                                        blank_col = "Group",
                                        blank_label = "Blank",
                                        flag_thresh = 0.39,
                                        flag_label = "Contaminant")
# Removal blank group from dataset
corrected_no_blank <- corrected_no_blank[, corrected_no_blank$Group != "Blank"]

# Exporting data to clean identified features
#write_to_excel(corrected_no_blank,
#               "Result/notame_Result/MZmine_corrected_no_blank.xlsx")

```

Dta visualization...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Boxplot
no_blank_bp <- plot_sample_boxplots(corrected_no_blank,
                                 order_by = "QC",
                                 fill_by = "QC")
# PCA
no_blank_pca <- plot_pca(corrected_no_blank,
                      center = TRUE,
                      shape = "QC",
                      color = "QC")
# Plot
no_blank_pca + no_blank_bp

```

The next step...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Clustering correlated features
clustered <- cluster_features(corrected_no_blank,
                              rt_window = 1/180,
                              corr_thresh = 0.95,
                              d_thresh = 0.80,
                              #plotting = TRUE,
                              #prefix = paste0(ppath, "Result/notame_Result/Cluster")
                              )
# Extracting representative feature of each cluster
compressed <- compress_clusters(clustered)
# Exporting data to inspect identified features
#write_to_excel(compressed,
#               "Result/notame_Result/MZmine_compressed.xlsx")

```

We can visualize data...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
clust_bp <- plot_sample_boxplots(compressed,
                                 order_by = "QC",
                                 fill_by = "QC")
# PCA
clust_pca <- plot_pca(compressed,
                      center = TRUE,
                      shape = "QC",
                      color = "QC")
# Plot
clust_pca + clust_bp

```

Finally the data is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

#save(imputed, file = paste0(ppath, "Result/notame_Result/HS_GCMS/Notame_HS_GC-MS_out.RData"))

```

# PCA plots

Here read this paper: https://doi.org/10.1007%2Fs11306-016-1030-9

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Impute missing values using random forest
# To clean data
set.seed(1010)
imputed <- impute_rf(compressed)
# To all data
imputed <- impute_rf(imputed, all_features = TRUE)

```

We can inspect PCA plot after...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
imp_bp <- plot_sample_boxplots(imputed,
                               order_by = "QC",
                               fill_by = "QC")
# PCA
imp_pca <- plot_pca(imputed,
                    center = TRUE,
                    shape = "QC",
                    color = "QC")
# Plot
imp_pca + imp_bp

```

The next step...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Probabilistic quotient normalization
pqn_set <- pqn_normalization(imputed,
                             ref = c("qc", "all"),
                             method = c("median", "mean"),
                             all_features = FALSE)

```

We can inspect PCA plot after...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
pqn_bp <- plot_sample_boxplots(pqn_set,
                               order_by = "QC",
                               fill_by = "QC")
# PCA
pqn_pca <- plot_pca(pqn_set,
                    center = TRUE,
                    shape = "QC",
                    color = "QC")
# Plot
pqn_pca + pqn_bp

```

## PCA of all sample

Droping flagged features...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extract clean data
no_flag <- drop_flagged(pqn_set)
# Extracting feature height table
pmp_peakheight <- exprs(no_flag)
# Extracting Phenotipic data
pmp_phenodata <- no_flag@phenoData@data

```

The next step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# "SummarizedExperiment" package installation
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("SummarizedExperiment")
library(SummarizedExperiment)
# Convert feature height table to SummarizedExperiment class
pmp_data <- SummarizedExperiment(assays = pmp_peakheight,
                                 colData = pmp_phenodata)
# Package to generalized logarithmic transform
#if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("pmp")
library(pmp)
# Generalised logarithmic transform
glog_exprs <- glog_transformation(df = pmp_data@assays@data@listData[[1]],
                                  classes = pmp_data$QC,
                                  qc_label = "QC")
# Adding glog transformation to notame MetaboSet
glog_set <- no_flag
exprs(glog_set) <- glog_exprs

```

Extracting feature metadata

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting feature height table
peak_height <- exprs(glog_set)
# Extracting Phenotipic data
pheno_data <- glog_set@phenoData@data

```

Preparing data and transposing feature table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table  <- t(glog_set)
# Centering and Scaling features
ei_pca <- prcomp(transp_table, center = TRUE, scale. = TRUE)

```

Plotting PCA results.

Light condition level PCA plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Library to left_join use
library(dplyr)
# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data )                 # Adding metadata
# Change the order of legend column of DataFrame
scores$Light_factor <- factor(scores$Light_factor,
                              levels = c("Light",
                                         "Shade",
                                         "Other factor",
                                         "QC"))
scores$Analysis_group <- factor(scores$Analysis_group,
                                levels = c("Sample",
                                           "Sub_Quality_Control",
                                           "QC"),
                                labels=c("Sample",
                                         "SubQC",
                                         "QC"))
# PCA plot
figure_1a <- ggplot(scores,
                     aes(PC1, PC2, shape = Analysis_group,
                         color = Light_factor)) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#D3D9D9FF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(1, 17, 15)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (15.52 %)"),
         y=guide_axis(title = "PC2 (13.45 %)"),
         shape = guide_legend(order = 2),
         color = guide_legend(order = 1)) +
  labs(shape = 'Analysis group', color= 'Light level') +
  theme_classic() +
#  theme(legend.position = c(0.88, 0.80),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_1a
# Save plot
#ggsave('Result/notame_Result/Figure_1a.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Period age level PCA plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data )                 # Adding metadata
# Change the order of legend column of DataFrame
scores$Age_factor <- factor(scores$Age_factor,
                 levels = c("Early",
                            "Medium",
                            "Late",
                            "Other factor",
                            "QC"))
scores$Analysis_group <- factor(scores$Analysis_group,
                 levels = c("Sample",
                            "Sub_Quality_Control",
                            "QC"),
                 labels=c("Sample",
                          "SubQC",
                          "QC"))
# PCA plot
figure_1b <- ggplot(scores,
                     aes(PC1, PC2, shape = Analysis_group,
                         color = Age_factor)) +
  scale_color_manual(values=c("#E76BF3",
                              "#00B0F6",
                              "#F8766D",
                              "#D3D9D9FF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(1, 17, 15)) + 
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (15.52 %)"),
         y=guide_axis(title = "PC2 (13.45 %)"),
         shape = guide_legend(order = 2),
         color = guide_legend(order = 1)) +
  labs(shape = 'Analysis group', color= 'Age level') +
  theme_classic() +
#  theme(legend.position = c(0.88, 0.77),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_1b
# Save plot
#ggsave('Result/notame_Result/Figure_1b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Location level PCA plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data )                 # Adding metadata
# Change the order of legend column of DataFrame
scores$Location_factor <- factor(scores$Location_factor,
                 levels = c("Alto Pano",
                            "Alto Tena",
                            "Talag",
                            "Other factor",
                            "QC"))
scores$Analysis_group <- factor(scores$Analysis_group,
                 levels = c("Sample",
                            "Sub_Quality_Control",
                            "QC"),
                 labels=c("Sample",
                          "SubQC",
                          "QC"))
# PCA plot
figure_1c <- ggplot(scores,
                     aes(PC1, PC2, shape = Analysis_group,
                         color = Location_factor)) +
  scale_color_manual(values=c("#B24422FF",
                              "#4F9D4EFF",
                              "#4457A5FF",
                              "#D3D9D9FF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(1, 17, 15)) + 
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (15.52 %)"),
         y=guide_axis(title = "PC2 (13.45 %)")) +
  labs(shape = 'Analysis group', color= 'Location level') +
  theme_classic() +
#  theme(legend.position = c(0.88, 0.77),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_1c
# Save plot
#ggsave('Result/notame_Result/Figure_1c.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting loading results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings <- ei_pca$rotation %>%           # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with Feature name and Compound column.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Extracting feature identified
metab_data <- no_flag[!is.na(no_flag@featureData@data$Metabolite),]
# Extracting metabolite table
meta_table <- metab_data@featureData@data
# Creating a new small table with the annotated compounds
ei_compouds <- left_join(meta_table, loadings)
# Plotting results
figure_1d <- ggplot(loadings, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = ei_compouds,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = ei_compouds,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.3,
                            cex = 2.5,
                            max.overlaps = 20) +
  guides(x=guide_axis(title = "PC1 (15.52 %)"),
         y=guide_axis(title = "PC2 (13.45 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_1d
# Save plot
#ggsave('Result/notame_Result/figure_1d.pdf',
#       width = 20, height = 10.5, device='pdf', dpi="print")

```

## PCA of each location

### Alto Pano

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}
# Drop factor pooled (subQC)
no_subqc <- pqn_set[, pqn_set$Analysis_group != "Sub_Quality_Control"]
# Extracting "Alto Pano" (B) data
b_data <- no_subqc[, no_subqc$Location_factor != "Alto Tena"]
b_data <- b_data[, b_data$Location_factor != "Talag"]
# Extracting clean data
b_data  <- drop_flagged(b_data)
# Extracting feature height table
peak_height2 <- exprs(b_data )
# Extracting Phenotipic data
pheno_data2 <- b_data@phenoData@data

```

The next step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Convert feature height table to SummarizedExperiment class
pmp_data2 <- SummarizedExperiment(assays = peak_height2,
                                  colData = pheno_data2)
# Generalized logarithmic transform
glog_set2 <- glog_transformation(df = pmp_data2@assays@data@listData[[1]],
                                 classes = pmp_data2$QC,
                                 qc_label = "QC")

```

Preparing data and transposing feature table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table2  <- t(glog_set2)
# Centering and Scaling features
ei_pca2 <- prcomp(transp_table2, center = TRUE, scale. = TRUE)

```

Plotting PCA results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores2 <- ei_pca2$x %>%                 # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data2)                 # Adding metadata
# Change the order of legend column of DataFrame
scores2$Age_factor <- factor(scores2$Age_factor,
                             levels = c("Early",
                                        "Medium",
                                        "Late",
                                        "QC"))
scores2$Light_factor <- factor(scores2$Light_factor,
                               levels = c("Light",
                                          "Shade",
                                          "QC"))
# PCA plot
figure_s1a <- ggplot(scores2,
                    aes(PC1, PC2, shape = Age_factor,
                        color = Light_factor)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (26.25 %)"),
         y=guide_axis(title = "PC2 (18.82 %)")) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(16, 17, 15, 8)) + 
  labs(shape = 'Age level',
       color='Light level') +
  theme_classic() +
#  theme(legend.position = c(0.90, 0.65),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_s1a
# Save plot
#ggsave('Result/notame_Result/figure_s1a.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting loading results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings2 <- ei_pca2$rotation %>%         # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with Feature name and Compound column.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table with the annotated compounds
ei_compouds2 <- left_join(meta_table, loadings2)
# Plotting results
figure_s1d <- ggplot(loadings2, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = ei_compouds2,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = ei_compouds2,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 20) +
  guides(x=guide_axis(title = "PC1 (26.25 %)"),
         y=guide_axis(title = "PC2 (18.82 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_s1d
# Save plot
#ggsave('Result/notame_Result/figure_s1d.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Alto Tena

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting "Alto Tena" (C) data
c_data <- no_subqc[, no_subqc$Location_factor != "Alto Pano"]
c_data <- c_data[, c_data$Location_factor != "Talag"]
# Extracting clean data
c_data  <- drop_flagged(c_data)
# Extracting feature height table
peak_height3 <- exprs(c_data )
# Extracting Phenotipic data
pheno_data3 <- c_data@phenoData@data

```

The next step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Convert feature height table to SummarizedExperiment class
pmp_data3 <- SummarizedExperiment(assays = peak_height3,
                                  colData = pheno_data3)
# Generalized logarithmic transform
glog_set3 <- glog_transformation(df = pmp_data3@assays@data@listData[[1]],
                                 classes = pmp_data3$QC,
                                 qc_label = "QC")

```

Preparing data and transposing feature table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table3  <- t(glog_set3)
# Centering and Scaling features
ei_pca3 <- prcomp(transp_table3, center = TRUE, scale. = TRUE)

```

Plotting PCA results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores3 <- ei_pca3$x %>%                 # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pheno_data3)                 # Adding metadata
# Change the order of legend column of DataFrame
scores3$Age_factor <- factor(scores3$Age_factor,
                             levels = c("Early",
                                        "Medium",
                                        "Late",
                                        "QC"))
scores3$Light_factor <- factor(scores3$Light_factor,
                               levels = c("Light",
                                          "Shade",
                                          "QC"))
# PCA plot
figure_s1b <- ggplot(scores3,
                    aes(PC1, PC2, shape = Age_factor,
                        color = Light_factor)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (22.16 %)"),
         y=guide_axis(title = "PC2 (13.74 %)")) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(16, 17, 15, 8)) + 
  labs(shape = 'Age level',
       color = 'Light level') +
  theme_classic() +
#  theme(legend.position = c(0.08, 0.65),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_s1b
# Save plot
#ggsave('Result/notame_Result/figure_s1b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting loading results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings3 <- ei_pca3$rotation %>%         # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with Feature name and Compound column.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table of the annotated compounds
ei_compouds3 <- left_join(meta_table, loadings3)
# Plotting results
figure_s1e <- ggplot(loadings3, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = ei_compouds3,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = ei_compouds3,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 20) +
  guides(x=guide_axis(title = "PC1 (22.16 %)"),
         y=guide_axis(title = "PC2 (13.74 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_s1e
# Save plot
#ggsave('Result/notame_Result/figure_s1e.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Talag

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting "Talag" (A) data
a_data <- no_subqc[, no_subqc$Location_factor != "Alto Pano"]
a_data <- a_data[, a_data$Location_factor != "Alto Tena"]
# Extracting clean data
a_data  <- drop_flagged(a_data)
# Extracting feature height table
peak_height4 <- exprs(a_data )
# Extracting Phenotipic data
pheno_data4 <- a_data@phenoData@data

```

The next step is...

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Convert feature height table to SummarizedExperiment class
pmp_data4 <- SummarizedExperiment(assays = peak_height4,
                                  colData = pheno_data4)
# Generalized logarithmic transform
glog_set4 <- glog_transformation(df = pmp_data4@assays@data@listData[[1]],
                                 classes = pmp_data4$QC,
                                 qc_label = "QC")

```

Preparing data and transposing feature table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table4  <- t(glog_set4)
# Centering and Scaling features
ei_pca4 <- prcomp(transp_table4, center = TRUE, scale. = TRUE)

```

Plotting PCA results.

Light level PCA plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores4 <- ei_pca4$x %>%                # Get PC coordinates
  data.frame %>%                        # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%   # Create a new column with the sample names
  left_join(pheno_data4)                # Adding metadata
# Change the order of legend column of DataFrame
scores4$Age_factor <- factor(scores4$Age_factor,
                             levels = c("Early",
                                        "Medium",
                                        "Late",
                                        "QC"))
scores4$Light_factor <- factor(scores4$Light_factor,
                               levels = c("Light",
                                          "Shade",
                                          "QC"))
# PCA plot
figure_s1c <- ggplot(scores4,
                    aes(PC1, PC2, shape = Age_factor,
                        color = Light_factor)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (25.06 %)"),
         y=guide_axis(title = "PC2 (16.53 %)")) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(16, 17, 15, 8)) + 
  labs(shape = 'Age level',
       color='Light level') +
  theme_classic() +
#  theme(legend.position = c(1.08, 0.65),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_s1c
# Save plot
#ggsave('Result/notame_Result/figure_s1c.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting loading results.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings4 <- ei_pca4$rotation %>%         # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with Feature name and Compound column.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table of the annotated compounds
ei_compouds4 <- left_join(meta_table, loadings4)
# Plotting results
figure_s1f <- ggplot(loadings4, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = ei_compouds4,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = ei_compouds4,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 20) +
  guides(x=guide_axis(title = "PC1 (25.06 %)"),
         y=guide_axis(title = "PC2 (16.53 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_s1f
# Save plot
#ggsave('Result/notame_Result/figure_s1f.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

# Heatmap plot

Heatmap of identified metabolites.

ComplexHeatmap package and dependency package installation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# ComplexHeatmap package installation
#if (!requireNamespace("BiocManager", quietly=TRUE))
#    install.packages("BiocManager")
#BiocManager::install("ComplexHeatmap")
library(ComplexHeatmap)

# colorRamp2 package installation
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("jokergoo/colorRamp2")
library(colorRamp2)

# cowplot package installation
#install.packages("cowplot")
library(cowplot)

# mdatools package installation
#install_github('svkucheryavski/mdatools')
library(mdatools)

# ClassyFire package installation
#remotes::install_github('aberHRML/classyfireR')
library(classyfireR)

```

ClassyFire metabolite class classification.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

InChI_Keys <- c("QEOHJVNDENHRCH-VOTSOKGWSA-N",
                "JMFRWRFFLBVWSI-NSCUHMNNSA-N",
                "CCRCUPLGCSFEDV-BQYQJAHWSA-N",
                "RJXKHBTYHGBOKV-VQHVLOKHSA-N",
                "OSQBCSHERZVUGW-UHFFFAOYSA-N",
                "NIIUIBKEGRPPDK-UHFFFAOYSA-N",
                "LQZZUXJYWNFBMV-UHFFFAOYSA-N",
                "BXWNKGSJHAJOGX-UHFFFAOYSA-N",
                "CSQGINGXEBQJPA-UHFFFAOYSA-N",
                "HLZKNKRTKFSKGZ-UHFFFAOYSA-N",
                "ABFCOJLLBHXNOU-UHFFFAOYSA-N",
                "CDAWCLOXVUBKRW-UHFFFAOYSA-N",
                "BBNYCLAREVXOSG-UHFFFAOYSA-N",
                "OLNJUISKUQQNIM-UHFFFAOYSA-N",
                "BVNCCXWAZAZQNM-AATRIKPKSA-N",
                "VYKLRWGPNUVKNC-AATRIKPKSA-N",
                "NOORESDHJXLGAO-AATRIKPKSA-N",
                "PGSWEKYNAOWQDF-UHFFFAOYSA-N",
                "HFLGBNBLMBSXEM-UHFFFAOYSA-N",
                "ZBCATMYQYDCTIZ-UHFFFAOYSA-N",
                "YOMSJEATGXXYPX-UHFFFAOYSA-N",
                "BKASXWPLSXFART-HTQZYQBOSA-N",
                "XEVQXKKKAVVSMW-UHFFFAOYSA-N",
                "OJOBTAOGJIWAGB-UHFFFAOYSA-N",
                "DTUQWGWMVIHBKE-UHFFFAOYSA-N",
                "WPYMKLBDIGXBTP-UHFFFAOYSA-N",
                "UEEJDIUOCUCVHN-UHFFFAOYSA-N",
                "FSSVRXASHHVANB-UHFFFAOYSA-N",
                "RYYVLZVUVIJVGH-UHFFFAOYSA-N",
                "QHJGZUSJKGVMTF-UHFFFAOYSA-N",
                "RQCMOYRPNPEGDL-UHFFFAOYSA-N",
                "YCIMNLLNPGFGHC-UHFFFAOYSA-N",
                "JNSUZRHLHDQGPN-HJWRWDBZSA-N",
                "HBEDSQVIWPRPAY-UHFFFAOYSA-N",
                "NMEZJSDUZQOPFE-UHFFFAOYSA-N",
                "CFAKWWQIUFSQFU-UHFFFAOYSA-N",
                "DIOQZVSQGTUSAI-UHFFFAOYSA-N",
                "RPEASMBMVIKUTH-UHFFFAOYSA-N",
                "KNHUHSLRIKTCIY-UHFFFAOYSA-N",
                "MWOMNLDJNQWJMK-UHFFFAOYSA-N",
                "PHOPGVYKZWPIGA-UHFFFAOYSA-N",
                "LIKYNOPXHGPMIH-UHFFFAOYSA-N",
                "JRXXLCKWQFKACW-UHFFFAOYSA-N",
                "HOWGUJZVBDQJKV-UHFFFAOYSA-N",
                "UAUDZVJPLUQNMU-KTKRTIGZSA-N",
                "QVGDVJSCRGIGEX-WAYWQWQTSA-N",
                "XIRNKXNNONJFQO-UHFFFAOYSA-N",
                "LFVCJQWZGDLHSD-UHFFFAOYSA-N",
                "LHGVFZTZFXWLCP-UHFFFAOYSA-N",
                "FNAZRRHPUDJQCJ-UHFFFAOYSA-N",
                "HMSWAIKSFDFLKN-UHFFFAOYSA-N",
                "XMIIGOLPHOKFCH-UHFFFAOYSA-N",
                "QIGBRXMKCJKVMJ-UHFFFAOYSA-N",
                "SIKJAQJRHWYJAI-UHFFFAOYSA-N",
                "MGWAVDBGNNKXQV-UHFFFAOYSA-N",
                "TWNIBLMWSKIRAT-BYIBVSMXSA-N",
                "NITWSHWHQAQBAW-QPJJXVBHSA-N",
                "YZEGGKQFWJCIQG-UHFFFAOYSA-N",
                "HLMFEOFHBFXLNZ-UHFFFAOYSA-N",
                "UQDUPQYQJKYHQI-UHFFFAOYSA-N",
                "DVWSXZIHSUZZKJ-YSTUJMKBSA-N",
                "QYDYPVFESGNLHU-KHPPLWFESA-N",
                "FLIACVVOZYBSBS-UHFFFAOYSA-N",
                "IZFGRAGOVZCUFB-CMDGGOBGSA-N",
                "LFHHOHMIVKIHMG-UHFFFAOYSA-N",
                "CUBICSJJYOPOIA-UHFFFAOYSA-N",
                "LQERIDTXQFOHKA-UHFFFAOYSA-N",
                "RZJRJXONCZWCBN-UHFFFAOYSA-N",
                "IPCSVZSSVZVIGE-UHFFFAOYSA-N",
                "YKNWIILGEFFOPE-UHFFFAOYSA-N",
                "ISWSIDIOOBJBQZ-UHFFFAOYSA-N",
                "WRMNZCZEMHIOCP-UHFFFAOYSA-N",
                "BOTWFXYSPFMFNR-HMMYKYKNSA-N",
                "UUTGCNVYKLQLRV-UHFFFAOYSA-N",
                "YYPNJNDODFVZLE-UHFFFAOYSA-N",
                "YYGNTYWPHWGJRM-AAJYLUCBSA-N",
                "LZFOPEXOUVTGJS-ONEGZZNKSA-N",
                "KLIDCXVFHGNTTM-UHFFFAOYSA-N",
                "POOSGDOYLQNASK-UHFFFAOYSA-N",
                "YAPQBXQYLJRXSA-UHFFFAOYSA-N",
                "ZFXYFBGIUFBOJW-UHFFFAOYSA-N",
                "UIERETOOQGIECD-ONEGZZNKSA-N",
                "YFHOHYAUMDHSBX-SNAWJCMRSA-N",
                "RSJKGSCJYJTIGS-UHFFFAOYSA-N",
                "MWOOGOJBHIARFG-UHFFFAOYSA-N",
                "XDVDHFJMCJWDPI-UHFFFAOYSA-N")
Classification_List <- purrr::map(InChI_Keys, get_classification)

```

## Heatmap of subQC

Extracting and loaded of identified metabolites abundance.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Extracting identified metabolites
hm_set <- imputed[!is.na(imputed@featureData@data$Metabolite),]
# Probabilistic quotient normalization
hm_pqn <- pqn_normalization(hm_set,
                            ref = c("qc", "all"),
                            method = c("median", "mean"),
                            all_features = TRUE)
# Convert feature height table to SummarizedExperiment class
hm_pmp <- SummarizedExperiment(assays = exprs(hm_pqn),
                               colData = hm_pqn@phenoData@data)
# Generalised logarithmic transform
hm_glog <- glog_transformation(df = hm_pmp@assays@data@listData[[1]],
                               classes = hm_pmp$QC,
                               qc_label = "QC")
# Scaling by autoscaling method
hm_scl <- scale(t(hm_glog), center = TRUE, scale = TRUE)
# Adding autoscaling data to notame MetaboSet
scl_set <- hm_pqn
exprs(scl_set) <- t(hm_scl)
# Drop QC
hm_no_qc <- drop_qcs(scl_set)
# Drop samples
hm_no_sample <- hm_no_qc[, hm_no_qc$Analysis_group != "Sample"]

```

Scaling, row and top heatmap anotation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

set.seed(2571)
# Extracting feature height table
hm_height <- exprs(hm_no_sample)
# Extracting sample information
hm_pdata <- hm_no_sample@phenoData@data
# Extracting feature information
hm_fdata <- hm_no_sample@featureData@data
# Adding row and column name
rownames(hm_height) <- hm_fdata$Metabolite
colnames(hm_height) <- hm_pdata$Group
# Metabolite superclass color
cols_metclass <- c("Organic oxygen compounds" = "#C8876EFF",
                   "Benzenoids" = "#2F533CFF",
                   "Phenylpropanoids and polyketides" = "#63764EFF",
                   "Organoheterocyclic compounds" = "#A87735FF",
                   "Lipids and lipid-like molecules" = "#F3C571FF",
                   "Organic acids and derivatives" = "#EEB043FF",
                   "Hydrocarbons" = "#E0D2B5FF")
# Add row anotation to HeatMap
hm_row_ann <- rowAnnotation(`Superclass` = hm_fdata$classyfireR_Superclass,
                            col = list(`Superclass` = cols_metclass),
                            show_annotation_name = T,
                            show_legend=F)
# Factor levels color
cols_levels <- c("Shade" = "#32373AFF",
                 "Early" = "#E76BF3",
                 "Light" = "#F5BC5CFF",
                 "Late" = "#F8766D",
                 "Talag" = "#4457A5FF",
                 "Medium" = "#00B0F6",
                 "Alto Tena" = "#4F9D4EFF",
                 "Alto Pano" = "#B24422FF")
cols_light <- c("Light" = "#F5BC5CFF",
                "Shade" = "#32373AFF")
cols_age <- c("Early" = "#E76BF3",
              "Medium" = "#00B0F6",
              "Late" = "#F8766D")
cols_location <- c("Alto Pano" = "#B24422FF",
                   "Alto Tena" = "#4F9D4EFF",
                   "Talag" = "#4457A5FF")
# Add top anotation to HeatMap
top_info_ann <- HeatmapAnnotation(`Factor levels` = hm_pdata$Group,
                                  col = list(`Factor levels` = cols_levels),
                                  show_annotation_name = T,
                                  show_legend=F, 
                                  border = TRUE)
# Color scale
mycol <- colorRamp2(c(-2, 0, 2),
                    c("blue", "white", "red"))
# Heatmap matrix plotting
hm_plot <- Heatmap(hm_height,
                   col = mycol,
                   border_gp = grid::gpar(col = "black", lty = 0.05),
                   rect_gp = grid::gpar(col = "black", lwd = 0.75),
                   clustering_distance_columns = "euclidean",
                   clustering_method_columns = "complete",
                   top_annotation = top_info_ann,
                   right_annotation = hm_row_ann,
                   row_names_max_width = unit(10, "cm"),
                   show_heatmap_legend = FALSE,
                   row_km = 3, column_km = 3)
hm_plot

```

Adding legends to heatmap.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Color scale legend
lgd1 <- Legend(col_fun = mycol,
               title = "glog abundance",
               direction = "horizontal" )
# Factor levels legend
lgd2 <- Legend(labels = c("Light",
                          "Shade"),
               legend_gp = gpar(fill = cols_light),
               title = "Light level", ncol = 1)
lgd3 <- Legend(labels = c("Early",
                          "Medium",
                          "Late"),
               legend_gp = gpar(fill = cols_age),
               title = "Age level", ncol = 1)
lgd4 <- Legend(labels = c("Alto Pano",
                          "Alto Tena",
                          "Talag"),
               legend_gp = gpar(fill = cols_location),
               title = "Location level", ncol = 1)
# Metabolite class Legend
lgd5 <- Legend(labels = c(unique(hm_fdata$classyfireR_Superclass)),
               legend_gp = gpar(fill = cols_metclass),
               title = "Metabolite superclass", ncol = 3)

```

ComplexHeatmap plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

set.seed(2571)
# Converting to ggplot
gg_heatmap <- grid.grabExpr(draw(hm_plot))
gg_heatmap <- ggpubr::as_ggplot(gg_heatmap)
# Legends
all_legends <- packLegend(lgd1,
                          lgd2,
                          lgd3,
                          lgd4,
                          lgd5,
                          direction = "horizontal")
gg_legend <- grid.grabExpr(draw(all_legends))
gg_legend_fn <- ggpubr::as_ggplot(gg_legend)
# Heatmap plot
gcms_hm <- plot_grid(gg_legend_fn,
                     gg_heatmap, ncol = 1,
                     rel_heights = c(0.045, 0.880))
gcms_hm
# Save heatmap plot
#ggsave(filename = "Result/notame_Result/Figure_2.pdf", plot = gcms_hm,
#       width = 7, height = 10, units = "in", dpi = 300, scale = 1.7)
#ggsave(filename = "Result/notame_Result/Figure_2.png", plot = gcms_hm,
#       width = 7, height = 10, units = "in", dpi = 300, scale = 1.7)

```

## Heatmap of sample

Extracting sample data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Drop subQC
hm1_no_subqc <- hm_no_qc[, hm_no_qc$Analysis_group != "Sub_Quality_Control"]

```

Scaling, row and top heatmap anotation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

set.seed(2571)
# Extracting feature height table
hm1_height <- exprs(hm1_no_subqc)
# Extracting sample information
hm1_pdata <- hm1_no_subqc@phenoData@data
# Adding row and column name
rownames(hm1_height) <- hm_fdata$Metabolite
colnames(hm1_height) <- hm1_pdata$Group
# Factor levels color
cols_light <- c("Light" = "#F5BC5CFF",
                "Shade" = "#32373AFF")
cols_age <- c("Early" = "#E76BF3",
              "Medium" = "#00B0F6",
              "Late" = "#F8766D")
cols_location <- c("Alto Pano" = "#B24422FF",
                   "Alto Tena" = "#4F9D4EFF",
                   "Talag" = "#4457A5FF")
# Add top anotation to HeatMap
top_info_ann1 <- HeatmapAnnotation(`Light level` = hm1_pdata$Light_factor,
                                   `Age level` = hm1_pdata$Age_factor,
                                   `Location level` = hm1_pdata$Location_factor,
                                   col = list(`Light level` = cols_light,
                                              `Age level` = cols_age,
                                              `Location level` = cols_location),
                                   show_annotation_name = T,
                                   show_legend=F,
                                   border = TRUE)
# Color scale
mycol1 <- colorRamp2(c(-4, 0, 4),
                     c("blue", "white", "red"))
# Heatmap matrix plotting
hm1_plot <- Heatmap(hm1_height,
                    col = mycol1,
                    border_gp = grid::gpar(col = "black", lty = 0.05),
                    rect_gp = grid::gpar(col = "black", lwd = 0.75),
                    clustering_distance_columns = "euclidean",
                    clustering_method_columns = "complete",
                    top_annotation = top_info_ann1,
                    right_annotation = hm_row_ann,
                    row_names_max_width = unit(10, "cm"),
                    show_heatmap_legend = FALSE,
                    row_km = 3, column_km = 3)
hm1_plot

```

Adding legends to heatmap.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Color scale legend
lgd1_1hm <- Legend(col_fun = mycol1,
                   title = "glog abundance",
                   direction = "horizontal" )

```

ComplexHeatmap plot

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

set.seed(2548)
# Converting to ggplot
gg_heatmap1 <- grid.grabExpr(draw(hm1_plot))
gg_heatmap1 <- ggpubr::as_ggplot(gg_heatmap1)
# Legends
all_legends1 <- packLegend(lgd1_1hm,
                           lgd2,
                           lgd3, 
                           lgd4, 
                           lgd5,
                           direction = "horizontal")
gg_legend1 <- grid.grabExpr(draw(all_legends1))
gg_legend_fn1 <- ggpubr::as_ggplot(gg_legend1)
# Heatmap plot
gcms_hm1 <- plot_grid(gg_legend_fn1,
                     gg_heatmap1, ncol = 1,
                     rel_heights = c(0.045, 0.880))
gcms_hm1
# Save heatmap plot
ggsave(filename = "Result/notame_Result/Figure_S4.pdf", plot = gcms_hm1,
       width = 8, height = 10, units = "in", dpi = 300, scale = 1.7)
ggsave(filename = "Result/notame_Result/Figure_s4.png", plot = gcms_hm1,
       width = 8, height = 10, units = "in", dpi = 300, scale = 1.7)

```


# Exporting plot

## PCA plot of all samples

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Figure matrix
figure_1 <- arrangeGrob(figure_1a,
                        figure_1b,
                        figure_1c,
                        figure_1d,
                        layout_matrix = rbind(c(1, 2, 3),
                                               c(4, 4, 4),
                                               c(4, 4, 4)))
# Adding label to the figures
figure_one <- ggpubr::as_ggplot(figure_1) +
  draw_plot_label(label = LETTERS[1:4],
                  x = c(0, 0.332, 0.665, 0),
                  y = c(.99, .99, .99, .656))
# Exporting (*.pdf) file
#ggsave(filename = "Result/notame_Result/figure_1.pdf", plot = figure_one,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.png) file
#ggsave(filename = "Result/notame_Result/figure_1.png", plot = figure_one,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_1.jpg", plot = figure_one,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)

```

## PCA plot of each location

### Alto Pano

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Figure matrix
figure_s1 <- arrangeGrob(figure_s1a,
                         figure_s1b,
                         figure_s1c,
                         figure_s1d,
                         layout_matrix = rbind(c(1, 2, 3),
                                               c(4, 4, 4),
                                               c(4, 4, 4)))
# Adding label to the figures
figure_sone <- ggpubr::as_ggplot(figure_s1) +
  draw_plot_label(label = LETTERS[1:4],
                  x = c(0, 0.332, 0.665, 0),
                  y = c(.99, .99, .99, .656))
# Exporting (*.pdf) file
#ggsave(filename = "Result/notame_Result/figure_s1.pdf", plot = figure_sone,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.png) file
#ggsave(filename = "Result/notame_Result/figure_s1.png", plot = figure_sone,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_s1.jpg", plot = figure_sone,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)

```

### Alto Tena

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Figure matrix
figure_s2 <- arrangeGrob(figure_s1a,
                         figure_s1b,
                         figure_s1c,
                         figure_s1e,
                         layout_matrix = rbind(c(1, 2, 3),
                                               c(4, 4, 4),
                                               c(4, 4, 4)))
# Adding label to the figures
figure_stwo <- ggpubr::as_ggplot(figure_s2) +
  draw_plot_label(label = LETTERS[1:4],
                  x = c(0, 0.332, 0.665, 0),
                  y = c(.99, .99, .99, .656))
# Exporting (*.pdf) file
#ggsave(filename = "Result/notame_Result/figure_s2.pdf", plot = figure_stwo,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.png) file
#ggsave(filename = "Result/notame_Result/figure_s2.png", plot = figure_stwo,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_s2.jpg", plot = figure_stwo,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)

```

### Talag

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Figure matrix
figure_s3 <- arrangeGrob(figure_s1a,
                         figure_s1b,
                         figure_s1c,
                         figure_s1f,
                         layout_matrix = rbind(c(1, 2, 3),
                                               c(4, 4, 4),
                                               c(4, 4, 4)))
# Adding label to the figures
figure_sthree <- ggpubr::as_ggplot(figure_s3) +
  draw_plot_label(label = LETTERS[1:4],
                  x = c(0, 0.332, 0.665, 0),
                  y = c(.99, .99, .99, .656))
# Exporting (*.pdf) file
#ggsave(filename = "Result/notame_Result/figure_s3.pdf", plot = figure_sthree,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.png) file
#ggsave(filename = "Result/notame_Result/figure_s3.png", plot = figure_sthree,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)
# Exporting (*.jpg) file
#ggsave(filename = "Result/notame_Result/figure_s3.jpg", plot = figure_sthree,
#      width = 175, height = 120, units = "mm", dpi = 300, scale = 2.5)

```





Finish a record.

```{r}

finish_log()

```



