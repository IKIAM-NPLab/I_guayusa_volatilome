---
title: "Effect of age and light on the volatile profile of *Ilex guayusa* leaves - Multivariate statistical analysis"
author: "Jefferson Pastuña"
date: "2024-04-17"
output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
usethis::git_vaccinate()

```

# Introduction

This R Script aims to record the procedure for analyzing the volatile profile of *Ilex guayusa* leaves under different age and light conditions. Each step has a brief explanation, as well as code and graphics.

The data preprocessing workflow used was taken from ["notame": Workflow for Non-Targeted LC–MS Metabolic Profiling](https://doi.org/10.3390/metabo10040135), Which offers a wide variety of functions for perform metabolomic profile analysis.

# Data preprocessing

## Before to start

The "notame" package accepts as input a feature table that can be obtained through software such as MZmine, MS-DIAL, among others. In this case, the feature table was obtained with the help of MZmine. The (*.csv) file exported from MZmine was fixed to get the final feature table input according to the "notame" package format.

Modifications to the raw (*.csv) file can be summarized by adding and renaming columns. The added columns “Column” and “Ion Mode” allow for the analysis of samples with different types of columns and different ionization modes, respectively. Also, the cells corresponding to mass and retention time must be renamed so the "notame" package can detect and process them.

## Notame workflow

The “notame” package and other dependency packages were installed as a first step for the analysis.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Notame package installation
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("antonvsdata/notame", ref = "v0.3.1")

# Notame library call
library(notame)

# Dependency packages installation
install_dependencies

```

Then, a primary path and a log system were added to have a record of each process executed.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Main path
ppath <- "../I_guayusa_volatilome/"
# Log system
init_log(log_file = paste0(ppath, "Result/notame_Result/GCMS_log.txt"))

```

Next, the MZmine feature list in "notame" format was loaded.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

data <- read_from_excel(file = "Data/Data_to_notame/MZmine_Feature_List_2Notame.xlsx", sheet = 3, 
                        corner_row = 8, corner_column = "N", 
                        split_by = c("Column", "Ion mode"))

```

Once the data was loaded, the next step was to create a MetaboSet to work with R objects from now on.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

modes <- construct_metabosets(exprs = data$exprs, 
                              pheno_data = data$pheno_data, 
                              feature_data = data$feature_data,
                              group_col = "Group")

```

## Preprocessing

The first step of the preprocessing is to change the features with a value equal to 0 to NA.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Data extraction
mode <- modes$Rtx5MS_EI
# Change 0 value to NA
mode <- mark_nas(mode, value = 0)

```

Then, features with low detection rates are flagged and can be ignored or removed in subsequent analysis. The “notame" package uses two criteria to flag these features: the feature presence in a percentage of QC injections and the feature presence in a percentage within a sample group or class.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Low detection rate
mode <- flag_detection(mode, qc_limit = 10/14, group_limit = 2/3)

```

The following preprocessing step is drift correction, which is applied using smoothed cubic spline regression. In addition, features with low quality (features out of the "RSD_r < 0.3 & D_ratio_r < 0.6" condition) are added to the “Flag” column. The value of RSD < 0.3 for considering a low-quality feature was taken from [Procedures for large-scale metabolic profiling of serum and plasma using gas chromatography and liquid chromatography coupled to mass spectrometry](https://doi.org/10.1038/nprot.2011.335).

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Drift correction
corrected <- correct_drift(mode)
# Flag low quality features
corrected <- flag_quality(corrected,
                          condition = "RSD_r < 0.3 & D_ratio_r < 0.6")

```

Then, we can visualize the data after drift correction.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
corr_bp <- plot_sample_boxplots(corrected,
                                order_by = "QC",
                                fill_by = "QC")
# PCA
corr_pca <- plot_pca(corrected,
                     center = TRUE,
                     shape = "QC",
                     color = "QC")
# Package to plots visualization in a same windows
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("thomasp85/patchwork")
library(patchwork)
# Plot
corr_pca + corr_bp

```

Contaminant peaks based on the process blank sample will be removed.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of contaminants
corrected_no_blank <- flag_contaminants(corrected,
                                        blank_col = "Group",
                                        blank_label = "Blank",
                                        flag_thresh = 0.39,
                                        flag_label = "Contaminant")
# Removal blank group from dataset
corrected_no_blank <- corrected_no_blank[, corrected_no_blank$Group != "Blank"]
pData(corrected_no_blank) <- droplevels(pData(corrected_no_blank))
# Exporting data to clean identified features
#write_to_excel(corrected_no_blank,
#               "Result/notame_Result/MZmine_corrected_no_blank.xlsx")

```

We can inspect data after removing the contaminant features.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Boxplot
no_blank_bp <- plot_sample_boxplots(corrected_no_blank,
                                    order_by = "QC",
                                    fill_by = "QC")
# PCA
no_blank_pca <- plot_pca(corrected_no_blank,
                         center = TRUE,
                         shape = "QC",
                         color = "QC")
# Plot
no_blank_pca + no_blank_bp

```

The next step is feature clustering. This step helps us reduce the number of features of the same molecule that were split due to a 70 eV electron ionization (EI) environment.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Clustering correlated features
clustered <- cluster_features(corrected_no_blank,
                              rt_window = 1/180,
                              corr_thresh = 0.95,
                              d_thresh = 0.80,
                              #plotting = TRUE,
                              #prefix = paste0(ppath, "Result/notame_Result/Cluster/")
                              )
# Extracting representative feature of each cluster
compressed <- compress_clusters(clustered)
# Exporting data to inspect identified features
#write_to_excel(compressed,
#               "Result/notame_Result/MZmine_compressed.xlsx")

```

We can inspect the data using the PCA plot after the clustering algorithm execution.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
clust_bp <- plot_sample_boxplots(compressed,
                                 order_by = "QC",
                                 fill_by = "QC")
# PCA
clust_pca <- plot_pca(compressed,
                      center = TRUE,
                      shape = "QC",
                      color = "QC")
# Plot
clust_pca + clust_bp

```


For downstream statistical analysis, we used probabilistic quotient normalization (PQN) with random forest missing value imputation and generalized logarithm (glog) transformation method, which were taken from [Non-targeted UHPLC-MS metabolomic data processing methods: a comparative investigation of normalisation, missing value imputation, transformation and scaling](https://doi.org/10.1007/s11306-016-1030-9).

The code below imputes the data using a random forest algorithm.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Impute missing values using random forest
# To clean data
set.seed(1010)
imputed <- impute_rf(compressed)
# To all data
imputed <- impute_rf(imputed, all_features = TRUE)

```

We can inspect the data with the PCA plot after data imputation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
imp_bp <- plot_sample_boxplots(imputed,
                               order_by = "QC",
                               fill_by = "QC")
# PCA
imp_pca <- plot_pca(imputed,
                    center = TRUE,
                    shape = "QC",
                    color = "QC")
# Plot
imp_pca + imp_bp

```

After data imputation, the data was normalized by probabilistic quotient normalization (PQN).

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Probabilistic quotient normalization
pqn_set <- pqn_normalization(imputed,
                             ref = c("qc", "all"),
                             method = c("median", "mean"),
                             all_features = FALSE)

```

We can inspect the data with the PCA plot after data normalization.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Boxplot
pqn_bp <- plot_sample_boxplots(pqn_set,
                               order_by = "QC",
                               fill_by = "QC")
# PCA
pqn_pca <- plot_pca(pqn_set,
                    center = TRUE,
                    shape = "QC",
                    color = "QC")
# Plot
pqn_pca + pqn_bp

```

The data was transformed by the generalized logarithm (glog) method.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Extract clean data
ppm_noflag <- drop_flagged(pqn_set)
# "SummarizedExperiment" package installation
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("SummarizedExperiment")
library(SummarizedExperiment)
# Convert feature height table to SummarizedExperiment class
pmp_data <- SummarizedExperiment(assays = exprs(ppm_noflag),
                                 colData = ppm_noflag@phenoData@data)
# Package for generalized logarithmic transform
#if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("pmp")
library(pmp)
# Generalised logarithmic transform
glog_exprs <- glog_transformation(df = pmp_data@assays@data@listData[[1]],
                                  classes = pmp_data$QC,
                                  qc_label = "QC")
# Adding glog transformation to notame MetaboSet
glog_set <- ppm_noflag
exprs(glog_set) <- glog_exprs

```

Finally, the data is ready to be exported and proceed with the statistical analysis.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

#save(glog_set, file = paste0(ppath, "Result/notame_Result/notame_out.RData"))

```

# Univariate statistic

## Volcano plot

The generalized logarithm (glog) transformed data, and the probabilistic quotient normalization (PQN) data were used for volcano plot analysis. The two-sample t-test method (was calculated using glog transformed data) was used for the "y" axis of the volcano plot, and fold change (was calculated using PQN normalized data) was used for the "x" axis. We plotted two volcanoes, one with SubQC data and the other with individual data.

The first step was data extraction.

### SubQC volcano plot

SubQC data extraction for t-test calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of sample group from the dataset
volc_glog <- glog_set[, glog_set$Analysis_group != "Sample"]
pData(volc_glog) <- droplevels(pData(volc_glog))
# Drop QC
volc_glog <- drop_qcs(volc_glog)
# Extracting SubQC light factor
volc_glog <- volc_glog[, volc_glog$Light_factor != "Other factor"]
pData(volc_glog) <- droplevels(pData(volc_glog))

```

SubQC data extraction for fold change calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of sample group from the dataset
volc_pqn <- ppm_noflag[, ppm_noflag$Analysis_group != "Sample"]
pData(volc_pqn) <- droplevels(pData(volc_pqn))
# Drop QC
volc_pqn <- drop_qcs(volc_pqn)
# Extracting SubQC light factor
volc_pqn <- volc_pqn[, volc_pqn$Light_factor != "Other factor"]
pData(volc_pqn) <- droplevels(pData(volc_pqn))

```

Calculation of t-test and fold change.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Library to left_join use
library(dplyr)
# Fold change between shade and light levels
volc_fc <- fold_change(volc_pqn, group = "Light_factor")
# two-sample t-test performing
volc_t <- perform_t_test(volc_glog, formula_char = "Feature ~ Light_factor")
# Adding the fold change to the t-test data
volc_data <- left_join(volc_t, volc_fc)
# Log-transform for visualization
volc_data$logP <- -log10(volc_data$Light_vs_Shade_t_test_P)
volc_data$log2_fc <- log2(volc_data$Shade_vs_Light_FC)

```

Volcano plot of SubQC.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 9, fig.height = 15}

# Determine point colors based on significance and fold change
volc_data <- volc_data %>%
  mutate(point_color = case_when(
    Light_vs_Shade_t_test_P < 0.05 & log2_fc < -1 ~ "Down", # significantly down
    Light_vs_Shade_t_test_P < 0.05 & log2_fc > 1 ~ "Up",    # significantly up
    log2_fc < 1 & log2_fc > -1 ~ "No fold change",          # fold change < 2
    Light_vs_Shade_t_test_P > 0.05 & log2_fc < -1 | 
      Light_vs_Shade_t_test_P > 0.05 & log2_fc > 1 ~ "Fold change")) # fold change > 2
# Extracting feature identified
metab_data <- glog_set[!is.na(glog_set@featureData@data$Metabolite),]
# Extracting metabolite table
meta_table <- metab_data@featureData@data
# Creating a new small table of the annotated compounds
# Keep metabolites with p-value < 0.05
volc_compouds <- subset(volc_data, Light_vs_Shade_t_test_P < 0.05 |
                             point_color == "Fold change")
volc_compouds <- left_join(meta_table, volc_compouds)
# Volcano plot
vc_plot <- ggplot(volc_data, aes(log2_fc, logP, color = point_color)) +
  geom_point(size = 2, alpha = 0.4) +
  scale_colour_manual(values = c("No fold change" = "#808080",
                                 "Down" = "#4F9D4EFF",
                                 "Up" = "#ff80ff",
                                 "Fold change" = "#F5BC5CFF")) +
  theme_classic() +
  #theme(legend.position = "none") +
  #geom_point(data = volc_compouds,
  #           aes(shape = meta_table$Identification_level,
  #               color = meta_table$Identification_level),
  #           size = 2) +
  labs(#shape = 'Identification level',
       color = 'Color key') +
  ggrepel::geom_label_repel(data = volc_compouds,
                            aes(label = meta_table$Metabolite),
                            color = "black",
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 20,
                            min.segment.length = 0,
                            seed = 42,) +
  xlab(bquote(Log[2](Shade/Light))) + ylab(bquote(-Log[10](p-value))) +
  scale_y_continuous(limits = c(0,4), labels = function(i) 10^-i,
                     expand=c(0.003, 0.003)) +
  theme(legend.position = c(0.90, 0.947),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  #geom_vline(xintercept = 1, linetype = "longdash", colour="gray") +
  #geom_vline(xintercept = -1, linetype = "longdash", colour="gray") +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = -log10(0.05), linetype = "longdash", colour="gray")
vc_plot
# Save plot
#ggsave('Result/notame_Result/figure_2b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Sample volcano plot

Sample data extraction for t-test calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of sample group from the dataset
sp_volc_glog <- glog_set[, glog_set$Analysis_group != "Sub_Quality_Control"]
pData(sp_volc_glog) <- droplevels(pData(sp_volc_glog))
# Drop QC
sp_volc_glog <- drop_qcs(sp_volc_glog)

```

Sample data extraction for fold change calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of sample group from the dataset
sp_volc_pqn <- ppm_noflag[, ppm_noflag$Analysis_group != "Sub_Quality_Control"]
pData(sp_volc_pqn) <- droplevels(pData(sp_volc_pqn))
# Drop QC
sp_volc_pqn <- drop_qcs(sp_volc_pqn)

```

Calculation of t-test and fold change.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Fold change between shade and light levels
sp_volc_fc <- fold_change(sp_volc_pqn, group = "Light_factor")
# two-sample t-test performing
sp_volc_t <- perform_t_test(sp_volc_glog,
                            formula_char = "Feature ~ Light_factor")
# Adding the fold change to the t-test data
sp_volc_data <- left_join(sp_volc_t, sp_volc_fc)
# Log-transform for visualization
sp_volc_data$logP <- -log10(sp_volc_data$Light_vs_Shade_t_test_P)
sp_volc_data$log2_fc <- log2(sp_volc_data$Shade_vs_Light_FC)

```

Volcano plot of Sample.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 9, fig.height = 15}

# Determine point colors based on significance and fold change
sp_volc_data <- sp_volc_data %>%
  mutate(point_color = case_when(
    Light_vs_Shade_t_test_P < 0.05 & log2_fc < -1 ~ "Down", # significantly down
    Light_vs_Shade_t_test_P < 0.05 & log2_fc > 1 ~ "Up",    # significantly up
    log2_fc < 1 & log2_fc > -1 ~ "No fold change",          # fold change < 2
    Light_vs_Shade_t_test_P > 0.05 & log2_fc < -1 | 
      Light_vs_Shade_t_test_P > 0.05 & log2_fc > 1 ~ "Fold change")) # fold change > 2
# Creating a new small table of the annotated compounds
# Keep metabolites with p-value < 0.05
sp_volc_compouds <- subset(sp_volc_data, Light_vs_Shade_t_test_P < 0.05 |
                             point_color == "Fold change")
sp_volc_compouds <- left_join(meta_table, sp_volc_compouds)
# Volcano plot
sp_vc_plot <- ggplot(sp_volc_data, aes(log2_fc, logP, color = point_color)) +
  geom_point(size = 2, alpha = 0.4) +
  scale_colour_manual(values = c("No fold change" = "#808080",
                                 "Down" = "#4F9D4EFF",
                                 "Up" = "#ff80ff",
                                 "Fold change" = "#F5BC5CFF")) +
  theme_classic() +
  #theme(legend.position = "none") +
  #geom_point(data = volc_compouds,
  #           aes(shape = meta_table$Identification_level,
  #               color = meta_table$Identification_level),
  #           size = 2) +
  labs(#shape = 'Identification level',
       color = 'Color key') +
  ggrepel::geom_label_repel(data = sp_volc_compouds,
                            aes(label = meta_table$Metabolite),
                            color = "black",
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 20,
                            min.segment.length = 0,
                            seed = 42,) +
  xlab(bquote(Log[2](Shade/Light))) + ylab(bquote(-Log[10](p-value))) +
  scale_y_continuous(limits = c(0,4), labels = function(i) 10^-i,
                     expand=c(0.003, 0.003)) +
  theme(legend.position = c(0.90, 0.947),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  #geom_vline(xintercept = 1, linetype = "longdash", colour="gray") +
  #geom_vline(xintercept = -1, linetype = "longdash", colour="gray") +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = -log10(0.05), linetype = "longdash", colour="gray")
sp_vc_plot
# Save plot
#ggsave('Result/notame_Result/figure_2b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

## Tukey test

The tukey test was implemented to support the multivariate statistic by analyzing individual identified metabolites between age factors (with three levels: early, medium, and late). Only metabolites with data homoscedasticity were considered for the ANOVA test, and metabolites with significance (p-value < 0.05) were used for the Tukey test. The generalized logarithm (glog) transformed data was used for the Tukey test.

Previously, we tested with the auto-scaled data and found that seven metabolites did not satisfy the data homoscedasticity according to the Bartlett test. On the other hand, when we tested with the glog-transformed data, only two metabolites did not satisfy the data homoscedasticity. For the above reasons, we used log-transformed data for the Tukey test.

We analyzed two batches of data, one of the SubQC data and the other of the individual data.

### SubQC Tukey test

SubQC data extraction for Tukey test calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Drop QC
tk_no_qc <- drop_qcs(glog_set)
# Drop samples
tk_no_sample <- tk_no_qc[, tk_no_qc$Analysis_group != "Sample"]
pData(tk_no_sample) <- droplevels(pData(tk_no_sample))
# Extracting levels of age factor
tk_age <- tk_no_sample[, tk_no_sample$Age_factor != "Other factor"]
pData(tk_age) <- droplevels(pData(tk_age))
# Extracting identified metabolites
tk_age_set <- tk_age[!is.na(tk_age@featureData@data$Metabolite),]

```

Preparing data and metadata for Tukey test calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Extracting feature height table
tk_height <- exprs(tk_age_set)
# Extracting sample information
tk_pdata <- tk_age_set@phenoData@data
tk_pdata <- data.frame(Sample_ID = tk_pdata$Sample_ID,
                       Age_factor = tk_pdata$Age_factor)
# Extracting feature information
tk_fdata <- tk_age_set@featureData@data
tk_fdata <- data.frame(Feature_ID = tk_fdata$Feature_ID,
                       Metabolite = tk_fdata$Metabolite)
# Transposing feature height table
tk_height <- t(tk_height)
# Feature height table to dataframe
tk_height <- as.data.frame(tk_height)
# Convert the row names to sample ID
tk_height <- tk_height %>% 
  mutate(Sample_ID = rownames(tk_height))
# Adding age factor as variable
tk_height <- left_join(tk_pdata, tk_height)

```

The data is ready to test the data homoscedasticity. The Bartlett test was used to inspect the homogeneity of variance.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Create two empty vectors to add results
Feature_ID <- c()
bartlett_pValue <- c()
# Batch analysis
for(i in 3:80) {
  bar_res <- bartlett.test(tk_height[, i] ~ tk_height$Age_factor,
                           data = tk_height)
  bartlett_pValue <- c(bartlett_pValue, bar_res[["p.value"]])
  Feature_ID <- c(Feature_ID, names(tk_height[i]))
  tk_bar_res <- data.frame(Feature_ID, bartlett_pValue)
}
# Adding a description of the p-value
tk_bar_res <- tk_bar_res %>%
  mutate(bartlett_group = ifelse(bartlett_pValue > 0.05,
                                 "equal variance",
                                 "Unequal variance"))

```

Most metabolites showed equality of variances according to the Bartlett test. The next step will be the ANOVA test.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Create two empty vectors to add results
Feature_ID <- c()
anova_pValue <- c()
# Batch analysis
for(i in 3:80) {
  anova_model <- glm(tk_height[, i] ~ tk_height$Age_factor, data = tk_height)
  anova_res <- anova(anova_model, test = "LRT")
  anova_pValue <- c(anova_pValue, anova_res$`Pr(>Chi)`[2])
  Feature_ID <- c(Feature_ID, names(tk_height[i]))
  tk_anova_res <- data.frame(Feature_ID, anova_pValue)
}
# Adding a description of the p-value
tk_anova_res <- tk_anova_res %>%
  mutate(anova_group = ifelse(anova_pValue > 0.05,
                              "Not Significant",
                              "Significant"))

```

Consequently, the features with significance (p-value < 0.05) according to ANOVA were used for the Tukey test. Tukey test groups the different variables (in this case, the levels of age factor: early, medium, and late) using significance tests.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# agricolae package installation and library loadding
#install.packages("agricolae", repos = "https://cran.r-project.org")
library(agricolae)
# Create two empty vectors to add results
Feature_ID <- c()
tk_group_early <- c()
tk_group_late <- c()
tk_group_medium <- c()
# Batch analysis
for(i in 3:80) {
  tk_model <- aov(tk_height[, i] ~ tk_height$Age_factor, data = tk_height)
  tk_tes <- HSD.test(tk_model, "tk_height$Age_factor", group = TRUE)
  tk_group_early <- c(tk_group_early, tk_tes[["groups"]]["Early",2])
  tk_group_late <- c(tk_group_late, tk_tes[["groups"]]["Late",2])
  tk_group_medium <- c(tk_group_medium, tk_tes[["groups"]]["Medium",2])
  Feature_ID <- c(Feature_ID, names(tk_height[i]))
  tk_res <- data.frame(Feature_ID, tk_group_early, tk_group_late,
                       tk_group_medium)
  tk_res
}

```

Merge all results and add a flag in the Tukey result column: "-" for metabolites with unequal variance according to the Bartlett test and "ns" for metabolites not significant according to the ANOVA test.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Merge all results obtained in the Tukey test
tk_result <- left_join(tk_bar_res, tk_anova_res)
tk_result <- left_join(tk_result, tk_res)
# Flag metabolites
for(i in 1:78) {
  # Flag "-" metabolites that has unequal variance
  if (tk_result$bartlett_group[i] == "Unequal variance") {
		tk_result$tk_group_early[i] <- "-"
		tk_result$tk_group_medium[i] <- "-"
		tk_result$tk_group_late[i] <- "-"
  }
  # Flag "ns" metabolites not significant
  if (tk_result$anova_group[i] == "Not Significant" &
      tk_result$bartlett_group[i] == "equal variance") {
		tk_result$tk_group_early[i] <- "ns"
		tk_result$tk_group_medium[i] <- "ns"
		tk_result$tk_group_late[i] <- "ns"
}
 tk_result
}

```

Creating a Tukey result table to use in the heatmap.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Tukey table to heatmap
hm_tk_table <- data.frame(Feature_ID = tk_result$Feature_ID,
                          Early = tk_result$tk_group_early,
                          Late = tk_result$tk_group_late,
                          Medium = tk_result$tk_group_medium)

```

Print Tukey results in a table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# The "gt" package installation
#install.packages("gt")
library(gt)
# Adding metabolite name
tk_table <- left_join(tk_fdata, hm_tk_table)
# Deleting the Feature_ID column
tk_table <- subset(tk_table, select = -c(Feature_ID) )
tk_table %>%
  gt()%>% 
  tab_spanner(
    label = "Tukey test",
    columns = 2:4)%>%
  tab_source_note(source_note = "Note: Different lowercase letter within the 
                  same row indicates significant differences based on Tukey's 
                  multiple comparisons (p-value < 0.05, n = 3). '-' represents 
                  features with unequal variance according to Bartlett's test. 
                  'ns' are the features that do not have statistical 
                  differences (p-value > 0.05) according to the ANOVA test.")

```

### Sample Tukey test

Sample data extraction for Tukey test calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Drop factor pooled (subQC)
tk_no_subqc <- tk_no_qc[, tk_no_qc$Analysis_group != "Sub_Quality_Control"]
pData(tk_no_subqc) <- droplevels(pData(tk_no_subqc))
# Extracting identified metabolites
tk_no_subqc <- tk_no_subqc[!is.na(tk_no_subqc@featureData@data$Metabolite),]

```

Preparing data and metadata for Tukey test calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Extracting feature height table
tk_spl_height <- exprs(tk_no_subqc)
# Extracting sample information
tk_spl_pdata <- tk_no_subqc@phenoData@data
tk_spl_pdata <- data.frame(Sample_ID = tk_spl_pdata$Sample_ID,
                           Age_factor = tk_spl_pdata$Age_factor)
# Extracting feature information
tk_spl_fdata <- tk_no_subqc@featureData@data
tk_spl_fdata <- data.frame(Feature_ID = tk_spl_fdata$Feature_ID,
                           Metabolite = tk_spl_fdata$Metabolite)
# Transposing feature height table
tk_spl_height <- t(tk_spl_height)
# Feature height table to dataframe
tk_spl_height <- as.data.frame(tk_spl_height)
# Convert the row names to sample ID
tk_spl_height <- tk_spl_height %>% 
  mutate(Sample_ID = rownames(tk_spl_height))
# Adding age factor as variable
tk_spl_height <- left_join(tk_spl_pdata, tk_spl_height)

```

The data is ready to test the data homoscedasticity. The Bartlett test was used to inspect the homogeneity of variance.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Create two empty vectors to add results
Feature_ID <- c()
bartlett_pValue <- c()
# Batch analysis
for(i in 3:80) {
  bar_res <- bartlett.test(tk_spl_height[, i] ~ tk_spl_height$Age_factor,
                           data = tk_spl_height)
  bartlett_pValue <- c(bartlett_pValue, bar_res[["p.value"]])
  Feature_ID <- c(Feature_ID, names(tk_spl_height[i]))
  tk_spl_bar_res <- data.frame(Feature_ID, bartlett_pValue)
}
# Adding a description of the p-value
tk_spl_bar_res <- tk_spl_bar_res %>%
  mutate(bartlett_group = ifelse(bartlett_pValue > 0.05,
                                 "equal variance",
                                 "Unequal variance"))

```

Some metabolites showed equality of variances according to the Bartlett test. The next step will be the ANOVA test.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Create two empty vectors to add results
Feature_ID <- c()
anova_pValue <- c()
# Batch analysis
for(i in 3:80) {
  anova_model <- glm(tk_spl_height[, i] ~ tk_spl_height$Age_factor,
                     data = tk_spl_height)
  anova_res <- anova(anova_model, test = "LRT")
  anova_pValue <- c(anova_pValue, anova_res$`Pr(>Chi)`[2])
  Feature_ID <- c(Feature_ID, names(tk_spl_height[i]))
  tk_spl_anova_res <- data.frame(Feature_ID, anova_pValue)
}
# Adding a description of the p-value
tk_spl_anova_res <- tk_spl_anova_res %>%
  mutate(anova_group = ifelse(anova_pValue > 0.05,
                              "Not Significant",
                              "Significant"))

```

Consequently, the features with significance (p-value < 0.05) according to ANOVA were used for the Tukey test. Tukey test groups the different variables (in this case, the levels of age factor: early, medium, and late) using significance tests.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Create two empty vectors to add results
Feature_ID <- c()
tk_group_early <- c()
tk_group_late <- c()
tk_group_medium <- c()
# Batch analysis
for(i in 3:80) {
  tk_model <- aov(tk_spl_height[, i] ~ tk_spl_height$Age_factor,
                  data = tk_spl_height)
  tk_tes <- HSD.test(tk_model, "tk_spl_height$Age_factor", group = TRUE)
  tk_group_early <- c(tk_group_early, tk_tes[["groups"]]["Early",2])
  tk_group_late <- c(tk_group_late, tk_tes[["groups"]]["Late",2])
  tk_group_medium <- c(tk_group_medium, tk_tes[["groups"]]["Medium",2])
  Feature_ID <- c(Feature_ID, names(tk_spl_height[i]))
  tk_spl_res <- data.frame(Feature_ID, tk_group_early, tk_group_late,
                       tk_group_medium)
  tk_spl_res
}

```

Merge all results and add a flag in the Tukey result column: "-" for metabolites with unequal variance according to the Bartlett test and "ns" for metabolites not significant according to the ANOVA test.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Merge all results obtained in the Tukey test
tk_spl_result <- left_join(tk_spl_bar_res, tk_spl_anova_res)
tk_spl_result <- left_join(tk_spl_result, tk_spl_res)
# Flag "-" metabolites that has unequal variance
for(i in 1:78) {
  if (tk_spl_result$bartlett_group[i] == "Unequal variance") {
		tk_spl_result$tk_group_early[i] <- "-"
		tk_spl_result$tk_group_medium[i] <- "-"
		tk_spl_result$tk_group_late[i] <- "-"
  }
  if (tk_spl_result$anova_group[i] == "Not Significant" &
      tk_spl_result$bartlett_group[i] == "equal variance") {
		tk_spl_result$tk_group_early[i] <- "ns"
		tk_spl_result$tk_group_medium[i] <- "ns"
		tk_spl_result$tk_group_late[i] <- "ns"
}
 tk_spl_result
}

```

Creating a Tukey result table to use in the heatmap.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Tukey table to heatmap
hm_tk_table_spl <- data.frame(Feature_ID = tk_spl_result$Feature_ID,
                          Early = tk_spl_result$tk_group_early,
                          Late = tk_spl_result$tk_group_late,
                          Medium = tk_spl_result$tk_group_medium)

```

Print Tukey results in a table.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Adding metabolite name
tk_table_spl <- left_join(tk_fdata, hm_tk_table_spl)
# Deleting the Feature_ID column
tk_table_spl <- subset(tk_table_spl, select = -c(Feature_ID) )
tk_table_spl %>%
  gt()%>% 
  tab_spanner(
    label = "Tukey test",
    columns = 2:4)%>%
  tab_source_note(source_note = "Note: Different lowercase letter within the 
                  same row indicates significant differences based on Tukey's 
                  multiple comparisons (p-value < 0.05, n = 3). '-' represents 
                  features with unequal variance according to Bartlett's test. 
                  'ns' are the features that do not have statistical 
                  differences (p-value > 0.05) according to the ANOVA test.")

```

# Multivariate statistic

## Principal Component Analysis (PCA)

Extracting the data and metadata of notame MetaboSet for principal component analysis (PCA) plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting feature height table
pca_peakheight <- exprs(glog_set)
# Extracting Phenotipic data
pca_phenodata <- glog_set@phenoData@data

```

Transposing feature table and preparing the PCA data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
transp_table  <- t(pca_peakheight)
# Centering features
ei_pca <- prcomp(transp_table, center = TRUE, scale. = FALSE)

```

### Light factor PCA

Sunlight exposures of the plant PCA plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pca_phenodata)               # Adding metadata
# Change the order of legend column of DataFrame
scores$Light_factor <- factor(scores$Light_factor,
                              levels = c("Light",
                                         "Shade",
                                         "Other factor",
                                         "QC"))
scores$Analysis_group <- factor(scores$Analysis_group,
                                levels = c("Sample",
                                           "Sub_Quality_Control",
                                           "QC"),
                                labels=c("Sample",
                                         "SubQC",
                                         "QC"))
# PCA plot
figure_1a <- ggplot(scores,
                     aes(PC1, PC2, shape = Analysis_group,
                         color = Light_factor)) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#D3D9D9FF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(1, 17, 15)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (18.35 %)"),
         y=guide_axis(title = "PC2 (15.20 %)"),
         shape = guide_legend(order = 2),
         color = guide_legend(order = 1)) +
  labs(shape = 'Analysis group', color= 'Light factor') +
  theme_classic() +
#  theme(legend.position = c(0.88, 0.80),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_1a
# Save plot
#ggsave('Result/notame_Result/Figure_1a.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Age factor PCA

Plant ages PCA plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pca_phenodata)               # Adding metadata
# Change the order of legend column of DataFrame
scores$Age_factor <- factor(scores$Age_factor,
                 levels = c("Early",
                            "Medium",
                            "Late",
                            "Other factor",
                            "QC"))
scores$Analysis_group <- factor(scores$Analysis_group,
                 levels = c("Sample",
                            "Sub_Quality_Control",
                            "QC"),
                 labels=c("Sample",
                          "SubQC",
                          "QC"))
# PCA plot
figure_1b <- ggplot(scores,
                     aes(PC1, PC2, shape = Analysis_group,
                         color = Age_factor)) +
  scale_color_manual(values=c("#E76BF3",
                              "#00B0F6",
                              "#F8766D",
                              "#D3D9D9FF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(1, 17, 15)) + 
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (18.35 %)"),
         y=guide_axis(title = "PC2 (15.20 %)"),
         shape = guide_legend(order = 2),
         color = guide_legend(order = 1)) +
  labs(shape = 'Analysis group', color= 'Age factor') +
  theme_classic() +
#  theme(legend.position = c(0.88, 0.77),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_1b
# Save plot
#ggsave('Result/notame_Result/Figure_1b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Location factor PCA

Sample collected location PCA plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
scores <- ei_pca$x %>%                   # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(pca_phenodata)               # Adding metadata
# Change the order of legend column of DataFrame
scores$Location_factor <- factor(scores$Location_factor,
                 levels = c("Alto Pano",
                            "Alto Tena",
                            "Talag",
                            "Other factor",
                            "QC"))
scores$Analysis_group <- factor(scores$Analysis_group,
                 levels = c("Sample",
                            "Sub_Quality_Control",
                            "QC"),
                 labels=c("Sample",
                          "SubQC",
                          "QC"))
# PCA plot
figure_1c <- ggplot(scores,
                     aes(PC1, PC2, shape = Analysis_group,
                         color = Location_factor)) +
  scale_color_manual(values=c("#B24422FF",
                              "#4F9D4EFF",
                              "#4457A5FF",
                              "#D3D9D9FF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(1, 17, 15)) + 
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (18.35 %)"),
         y=guide_axis(title = "PC2 (15.20 %)")) +
  labs(shape = 'Analysis group', color= 'Location factor') +
  theme_classic() +
#  theme(legend.position = c(0.88, 0.77),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_1c
# Save plot
#ggsave('Result/notame_Result/Figure_1c.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting a loading PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

loadings <- ei_pca$rotation %>%           # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with feature names and a compound column (with identified metabolites).

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table with the annotated compounds
ei_compouds <- left_join(meta_table, loadings)
# Plotting results
figure_1d <- ggplot(loadings, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = ei_compouds,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = ei_compouds,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.22,
                            label.padding = 0.22,
                            label.r = 0.3,
                            cex = 2.5,
                            max.overlaps = 7,
                            min.segment.length = 0) +
  guides(x=guide_axis(title = "PC1 (18.35 %)"),
         y=guide_axis(title = "PC2 (15.20 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_1d
# Save plot
#ggsave('Result/notame_Result/figure_1d.pdf',
#       width = 20, height = 10.5, device='pdf', dpi="print")

```

### Alto Pano location PCA

Extracting the Alto Pano location data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Drop factor pooled (subQC)
no_subqc <- glog_set[, glog_set$Analysis_group != "Sub_Quality_Control"]
pData(no_subqc) <- droplevels(pData(no_subqc))
# Extracting "Alto Pano" (B) data
b_data <- no_subqc[, no_subqc$Location_factor != "Alto Tena"]
pData(b_data) <- droplevels(pData(b_data))
b_data <- b_data[, b_data$Location_factor != "Talag"]
pData(b_data) <- droplevels(pData(b_data))
# Extracting feature height table
b_peakheight <- exprs(b_data)
# Extracting Phenotipic data
b_phenodata <- b_data@phenoData@data

```

Transposing feature table and preparing the PCA data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
b_transp_table  <- t(b_peakheight)
# Centering and Scaling features
b_pca <- prcomp(b_transp_table, center = TRUE, scale. = FALSE)

```

Plotting the Alto Pano PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
b_scores <- b_pca$x %>%                  # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(b_phenodata)                 # Adding metadata
# Change the order of legend column of DataFrame
b_scores$Age_factor <- factor(b_scores$Age_factor,
                              levels = c("Early",
                                         "Medium",
                                         "Late",
                                         "QC"))
b_scores$Light_factor <- factor(b_scores$Light_factor,
                                levels = c("Light",
                                           "Shade",
                                           "QC"))
# PCA plot
figure_s1a <- ggplot(b_scores,
                     aes(PC1, PC2, shape = Age_factor,
                         color = Light_factor)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (32.40 %)"),
         y=guide_axis(title = "PC2 (21.22 %)")) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(16, 17, 15, 8)) + 
  labs(shape = 'Age factor',
       color='Light factor') +
  theme_classic() +
#  theme(legend.position = c(0.90, 0.65),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_s1a
# Save plot
#ggsave('Result/notame_Result/figure_s1a.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting the Alto Pano loading PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

b_loadings <- b_pca$rotation %>%          # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with feature names and a compound column (with identified metabolites).

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table with the annotated compounds
b_compouds <- left_join(meta_table, b_loadings)
# Plotting results
figure_s1d <- ggplot(b_loadings, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = b_compouds,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = b_compouds,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 7) +
  guides(x=guide_axis(title = "PC1 (32.40 %)"),
         y=guide_axis(title = "PC2 (21.22 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_s1d
# Save plot
#ggsave('Result/notame_Result/figure_s1d.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Alto Tena location PCA

Extracting the Alto Tena location data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting "Alto Tena" (C) data
c_data <- no_subqc[, no_subqc$Location_factor != "Alto Pano"]
pData(c_data) <- droplevels(pData(c_data))
c_data <- c_data[, c_data$Location_factor != "Talag"]
pData(c_data) <- droplevels(pData(c_data))
# Extracting feature height table
c_peakheight <- exprs(c_data )
# Extracting Phenotipic data
c_phenodata <- c_data@phenoData@data

```

Transposing feature table and preparing the PCA data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
c_transptable  <- t(c_peakheight)
# Centering and Scaling features
c_pca <- prcomp(c_transptable, center = TRUE, scale. = FALSE)

```

Plotting the Alto Tena PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
c_scores <- c_pca$x %>%                  # Get PC coordinates
  data.frame %>%                         # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%    # Create a new column with the sample names
  left_join(c_phenodata)                 # Adding metadata
# Change the order of legend column of DataFrame
c_scores$Age_factor <- factor(c_scores$Age_factor,
                              levels = c("Early",
                                         "Medium",
                                         "Late",
                                         "QC"))
c_scores$Light_factor <- factor(c_scores$Light_factor,
                                levels = c("Light",
                                           "Shade",
                                           "QC"))
# PCA plot
figure_s1b <- ggplot(c_scores,
                    aes(PC1, PC2, shape = Age_factor,
                        color = Light_factor)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (24.53 %)"),
         y=guide_axis(title = "PC2 (16.96 %)")) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(16, 17, 15, 8)) + 
  labs(shape = 'Age factor',
       color = 'Light factor') +
  theme_classic() +
#  theme(legend.position = c(0.08, 0.65),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_s1b
# Save plot
#ggsave('Result/notame_Result/figure_s1b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting the Alto Tena loading PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

c_loadings <- c_pca$rotation %>%          # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with feature names and a compound column (with identified metabolites).

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table of the annotated compounds
c_compouds <- left_join(meta_table, c_loadings)
# Plotting results
figure_s1e <- ggplot(c_loadings, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = c_compouds,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = c_compouds,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 7) +
  guides(x=guide_axis(title = "PC1 (24.53 %)"),
         y=guide_axis(title = "PC2 (16.96 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_s1e
# Save plot
#ggsave('Result/notame_Result/figure_s1e.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

### Talag location PCA

Extracting the Talag location data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Extracting "Talag" (A) data
a_data <- no_subqc[, no_subqc$Location_factor != "Alto Pano"]
pData(a_data) <- droplevels(pData(a_data))
a_data <- a_data[, a_data$Location_factor != "Alto Tena"]
pData(a_data) <- droplevels(pData(a_data))
# Extracting feature height table
a_peakheight <- exprs(a_data )
# Extracting Phenotipic data
a_phenodata <- a_data@phenoData@data

```

Transposing feature table and preparing the PCA data.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# Transposing feature height table
a_transptable  <- t(a_peakheight)
# Centering and Scaling features
a_pca <- prcomp(a_transptable, center = TRUE, scale. = FALSE)

```

Plotting the Talag PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# PCA scores
a_scores <- a_pca$x %>%                 # Get PC coordinates
  data.frame %>%                        # Convert to data frames
  mutate(Sample_ID = rownames(.)) %>%   # Create a new column with the sample names
  left_join(a_phenodata)                # Adding metadata
# Change the order of legend column of DataFrame
a_scores$Age_factor <- factor(a_scores$Age_factor,
                              levels = c("Early",
                                         "Medium",
                                         "Late",
                                         "QC"))
a_scores$Light_factor <- factor(a_scores$Light_factor,
                               levels = c("Light",
                                          "Shade",
                                          "QC"))
# PCA plot
figure_s1c <- ggplot(a_scores,
                    aes(PC1, PC2, shape = Age_factor,
                        color = Light_factor)) +
  geom_point(size = 3) +
  guides(x=guide_axis(title = "PC1 (31.23 %)"),
         y=guide_axis(title = "PC2 (21.11 %)")) +
  scale_color_manual(values=c("#F5BC5CFF",
                              "#32373AFF",
                              "#00BFC4")) +
  scale_shape_manual(values=c(16, 17, 15, 8)) + 
  labs(shape = 'Age factor',
       color = 'Light factor') +
  theme_classic() +
#  theme(legend.position = c(1.08, 0.65),
#        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray")
figure_s1c
# Save plot
#ggsave('Result/notame_Result/figure_s1c.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

Plotting the Talag loading PCA result.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

a_loadings <- a_pca$rotation %>%          # Extract loadings
  data.frame(Feature_ID = rownames(.))    # New column with feat name

```

Creating an artificial table with feature names and a compound column (with identified metabolites).

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide', fig.width = 20, fig.height = 10.5}

# Creating a new small table of the annotated compounds
a_compouds <- left_join(meta_table, a_loadings)
# Plotting results
figure_s1f <- ggplot(a_loadings, aes(PC1, PC2)) +
  geom_point(alpha = 0.2) +
  theme_classic() + 
  geom_point(data = a_compouds,
             aes(shape = meta_table$Identification_level,
                 color = meta_table$Identification_level),
             size = 2) +
  labs(shape = 'Identification level',
       color = 'Identification level') +
  ggrepel::geom_label_repel(data = a_compouds,
                            aes(label = meta_table$Metabolite),
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 7) +
  guides(x=guide_axis(title = "PC1 (31.23 %)"),
         y=guide_axis(title = "PC2 (21.11 %)")) +
  theme(legend.position = c(0.945, 0.913),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent")) +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = 0, linetype = "longdash", colour="gray") +
  ggsci::scale_color_aaas()
figure_s1f
# Save plot
#ggsave('Result/notame_Result/figure_s1f.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

## Heatmap and HCA

Only the annotated features were used in the heatmap and the hierarchical cluster analysis (HCA). Also, the PCA result showed more clear separation of the levels in the SubQC than individual samples; for this reason, the SubQC data was used in the heatmap analysis. For better heatmap plot visualization, we scaled (by autoscaling method) the glog-transformed data. The ComplexHeatmap package will be used for the heatmap and the hierarchical cluster analysis (HCA).

ComplexHeatmap package and other dependency package installation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, results='hide'}

# ComplexHeatmap package installation
#if (!requireNamespace("BiocManager", quietly=TRUE))
#    install.packages("BiocManager")
#BiocManager::install("ComplexHeatmap")
library(ComplexHeatmap)

# colorRamp2 package installation
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  install.packages("devtools")
#}
#devtools::install_github("jokergoo/colorRamp2")
library(colorRamp2)

# cowplot package installation
#install.packages("cowplot")
library(cowplot)

# mdatools package installation
#install_github('svkucheryavski/mdatools')
library(mdatools)

# ClassyFire package installation
#remotes::install_github('aberHRML/classyfireR')
library(classyfireR)

```

The metabolites were classified using the [ClassyFireR](https://doi.org/10.1186/s13321-016-0174-y) to add these metabolite classifications to the heatmap plot.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# InChI key of the metabolites you want to classify
InChI_Keys <- c(Benzeneacetaldehyde = "DTUQWGWMVIHBKE-UHFFFAOYSA-N")
# Get classification
Classification_List <- purrr::map(InChI_Keys, get_classification)
Classification_List

```

### Heatmap and HCA of age

Scaling glog data by  auto-Scaling method and age factor data extraction.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Scaling by autoscaling method
hm_scl <- scale(t(glog_exprs), center = TRUE, scale = TRUE)
hm_scl <- t(hm_scl)
# Adding autoscaling data to notame MetaboSet
hm_scl_set <- ppm_noflag
exprs(hm_scl_set) <- hm_scl
# Drop QC
hm_no_qc <- drop_qcs(hm_scl_set)
# Drop samples
hm_no_sample <- hm_no_qc[, hm_no_qc$Analysis_group != "Sample"]
pData(hm_no_sample) <- droplevels(pData(hm_no_sample))
# Extracting levels of age factor
hm_age <- hm_no_sample[, hm_no_sample$Age_factor != "Other factor"]
pData(hm_age) <- droplevels(pData(hm_age))
# Extracting identified metabolites
hm_age_set <- hm_age[!is.na(hm_age@featureData@data$Metabolite),]

```

We improve heatmap visualization by adding the Tukey test as row annotation. The Tukey test calculation code is available in this notebook's [Univariate statistic] section.


```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Adding tukey test result
hm_age_set <- join_fData(hm_age_set, hm_tk_table)

```

Row and top heatmap annotation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 9, fig.height = 15}

set.seed(2571)
# Extracting feature height table
hm_height <- exprs(hm_age_set)
# Extracting sample information
hm_pdata <- hm_age_set@phenoData@data
# Extracting feature information
hm_fdata <- hm_age_set@featureData@data
# Adding row and column name
rownames(hm_height) <- hm_fdata$Metabolite
colnames(hm_height) <- hm_pdata$Group
# Metabolite superclass color
cols_metclass <- c("Organic oxygen compounds" = "#C8876EFF",
                   "Benzenoids" = "#2F533CFF",
                   "Phenylpropanoids and polyketides" = "#63764EFF",
                   "Organoheterocyclic compounds" = "#A87735FF",
                   "Lipids and lipid-like molecules" = "#F3C571FF",
                   "Organic acids and derivatives" = "#EEB043FF",
                   "Hydrocarbons" = "#E0D2B5FF")
# Add row anotation to HeatMap
hm_row_ann <- rowAnnotation(`Superclass` = hm_fdata$classyfireR_Superclass,
                            `Tukey test 2` = anno_text(hm_fdata$Late,
                                                       location = 0.5,
                                                       just = "center",
                                                       gp = gpar(fill = "#F8766D",
                                                                 col = "#666666"),
                                                       show_name = TRUE),
                            `Tukey test 1` = anno_text(hm_fdata$Medium,
                                                       location = 0.5,
                                                       just = "center",
                                                       gp = gpar(fill = "#00B0F6",
                                                                 col = "#666666"),
                                                       show_name = TRUE),
                            `Tukey test 0` = anno_text(hm_fdata$Early,
                                                       location = 0.5,
                                                       just = "center",
                                                       gp = gpar(fill = "#E76BF3",
                                                                 col = "#666666"),
                                                       show_name = TRUE),
                            col = list(`Superclass` = cols_metclass),
                            show_annotation_name = T,
                            show_legend = F)
# Factor levels color
cols_levels <- c("Shade" = "#32373AFF",
                 "Early" = "#E76BF3",
                 "Light" = "#F5BC5CFF",
                 "Late" = "#F8766D",
                 "Talag" = "#4457A5FF",
                 "Medium" = "#00B0F6",
                 "Alto Tena" = "#4F9D4EFF",
                 "Alto Pano" = "#B24422FF")
cols_light <- c("Light" = "#F5BC5CFF",
                "Shade" = "#32373AFF")
cols_age <- c("Early" = "#E76BF3",
              "Medium" = "#00B0F6",
              "Late" = "#F8766D")
cols_location <- c("Alto Pano" = "#B24422FF",
                   "Alto Tena" = "#4F9D4EFF",
                   "Talag" = "#4457A5FF")
# Add top anotation to HeatMap
top_info_ann <- HeatmapAnnotation(`Age factor` = hm_pdata$Group,
                                  col = list(`Age factor` = cols_levels),
                                  show_annotation_name = T,
                                  show_legend=F, 
                                  border = TRUE)
# Color scale
mycol <- colorRamp2(c(-2, 0, 2),
                    c("blue", "white", "red"))
# Heatmap matrix plotting
hm_plot <- Heatmap(hm_height,
                   col = mycol,
                   border_gp = grid::gpar(col = "black", lty = 0.05),
                   rect_gp = grid::gpar(col = "black", lwd = 0.75),
                   clustering_distance_columns = "euclidean",
                   clustering_method_columns = "complete",
                   top_annotation = top_info_ann,
                   right_annotation = hm_row_ann,
                   row_names_max_width = unit(10, "cm"),
                   show_heatmap_legend = FALSE,
                   row_km = 3, column_km = 2,
                   row_title = c("a", "b", "c"))
hm_plot

```

Adding legends to heatmap.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Color scale legend
lgd1 <- Legend(col_fun = mycol,
               title = "glog abundance",
               direction = "horizontal" )
# Factor levels legend
lgd2 <- Legend(labels = c("Light (+)",
                          "Shade (-)"),
               legend_gp = gpar(fill = cols_light),
               title = "Light factor", ncol = 1)
lgd3 <- Legend(labels = c("Early (0)",
                          "Medium (1)",
                          "Late (2)"),
               legend_gp = gpar(fill = cols_age),
               title = "Age factor", ncol = 1)
lgd4 <- Legend(labels = c("Alto Pano (B)",
                          "Alto Tena (C)",
                          "Talag (A)"),
               legend_gp = gpar(fill = cols_location),
               title = "Location factor", ncol = 1)
# Metabolite class Legend
lgd5 <- Legend(labels = c(unique(hm_fdata$classyfireR_Superclass)),
               legend_gp = gpar(fill = cols_metclass),
               title = "Metabolite superclass", ncol = 3)

```

Heatmap plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 9, fig.height = 15}

set.seed(2571)
# Converting to ggplot
gg_heatmap <- grid.grabExpr(draw(hm_plot))
gg_heatmap <- ggpubr::as_ggplot(gg_heatmap)
# Legends
all_legends <- packLegend(lgd1,
                          #lgd2,
                          lgd3,
                          #lgd4,
                          lgd5,
                          direction = "horizontal")
gg_legend <- grid.grabExpr(draw(all_legends))
gg_legend_fn <- ggpubr::as_ggplot(gg_legend)
# Heatmap plot
gcms_hm <- plot_grid(gg_legend_fn,
                     gg_heatmap, ncol = 1,
                     rel_heights = c(0.045, 0.880))
gcms_hm
# Save heatmap plot
#ggsave(filename = "Result/notame_Result/Figure_2a.pdf", plot = gcms_hm,
#       width = 7, height = 10, units = "in", dpi = 300, scale = 1.7)
#ggsave(filename = "Result/notame_Result/Figure_2a.png", plot = gcms_hm,
#       width = 7, height = 10, units = "in", dpi = 300, scale = 1.7)

```

### Heatmap and HCA of sample

Using the scaled data of the age heatmap, we extract sample data of identified metabolites.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Drop subQC
hm_no_subqc <- hm_no_qc[, hm_no_qc$Analysis_group != "Sub_Quality_Control"]
pData(hm_no_subqc) <- droplevels(pData(hm_no_subqc))
# Extracting identified metabolites
hm_age_spl <- hm_no_subqc[!is.na(hm_no_subqc@featureData@data$Metabolite),]

```

We improve heatmap visualization by adding the Tukey test as row annotation. The Tukey test calculation code is available in this notebook's [Univariate statistic] section.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Adding tukey test result
hm_age_spl <- join_fData(hm_age_spl, hm_tk_table_spl)

```

Row and top heatmap annotation.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 14, fig.height = 13}

set.seed(2571)
# Extracting feature height table
hm_height_spl <- exprs(hm_age_spl)
# Extracting sample information
hm_pdata_spl <- hm_age_spl@phenoData@data
# Extracting feature information
hm_fdata_spl <- hm_age_spl@featureData@data
# Adding row and column name
rownames(hm_height_spl) <- hm_fdata_spl$Metabolite
colnames(hm_height_spl) <- hm_pdata_spl$Group
# Add row anotation to HeatMap
hm_row_ann <- rowAnnotation(`Superclass` = hm_fdata_spl$classyfireR_Superclass,
                            col = list(`Superclass` = cols_metclass),
                            show_annotation_name = T,
                            show_legend = F)
# Factor levels color
cols_levels <- c("Shade" = "#32373AFF",
                 "Early" = "#E76BF3",
                 "Light" = "#F5BC5CFF",
                 "Late" = "#F8766D",
                 "Talag" = "#4457A5FF",
                 "Medium" = "#00B0F6",
                 "Alto Tena" = "#4F9D4EFF",
                 "Alto Pano" = "#B24422FF")
cols_light <- c("Light" = "#F5BC5CFF",
                "Shade" = "#32373AFF")
cols_age <- c("Early" = "#E76BF3",
              "Medium" = "#00B0F6",
              "Late" = "#F8766D")
cols_location <- c("Alto Pano" = "#B24422FF",
                   "Alto Tena" = "#4F9D4EFF",
                   "Talag" = "#4457A5FF")
# Add top anotation to HeatMap
top_info_ann <- HeatmapAnnotation(`Light factor` = hm_pdata_spl$Light_factor,
                                  `Age factor` = hm_pdata_spl$Age_factor,
                                  `Location factor` = hm_pdata_spl$Location_factor,
                                  col = list(`Light factor` = cols_light,
                                             `Age factor` = cols_age,
                                             `Location factor` = cols_location),
                                  show_annotation_name = T,
                                  show_legend=F, 
                                  border = TRUE)
# Color scale
mycol_spl <- colorRamp2(c(-4, 0, 4),
                    c("blue", "white", "red"))
# Heatmap matrix plotting
hm_plot_spl <- Heatmap(hm_height_spl,
                       col = mycol,
                       border_gp = grid::gpar(col = "black", lty = 0.05),
                       rect_gp = grid::gpar(col = "black", lwd = 0.75),
                       clustering_distance_columns = "euclidean",
                       clustering_method_columns = "complete",
                       top_annotation = top_info_ann,
                       right_annotation = hm_row_ann,
                       row_names_max_width = unit(10, "cm"),
                       show_heatmap_legend = FALSE,
                       row_km = 3, column_km = 2,
                       row_title = c("a", "b", "c"))
hm_plot_spl

```

Adding legends to heatmap.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Color scale legend
lgd_hm_spl <- Legend(col_fun = mycol_spl,
                     title = "glog abundance",
                     direction = "horizontal" )

```

Heatmap plot.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 14, fig.height = 13}

set.seed(2571)
# Converting to ggplot
gg_heatmap_spl <- grid.grabExpr(draw(hm_plot_spl))
gg_heatmap_spl <- ggpubr::as_ggplot(gg_heatmap_spl)
# Legends
all_legends_spl <- packLegend(lgd_hm_spl,
                           lgd2,
                           lgd3, 
                           lgd4, 
                           lgd5,
                           direction = "horizontal")
gg_legend_spl <- grid.grabExpr(draw(all_legends_spl))
gg_legend_fn_spl <- ggpubr::as_ggplot(gg_legend_spl)
# Heatmap plot
gcms_hm_spl <- plot_grid(gg_legend_fn_spl,
                     gg_heatmap_spl, ncol = 1,
                     rel_heights = c(0.045, 0.880))
gcms_hm_spl
# Save heatmap plot
#ggsave(filename = "Result/notame_Result/Figure_S4.pdf", plot = gcms_hm_spl,
#       width = 8, height = 10, units = "in", dpi = 300, scale = 1.7)
#ggsave(filename = "Result/notame_Result/Figure_s4.png", plot = gcms_hm_spl,
#       width = 8, height = 10, units = "in", dpi = 300, scale = 1.7)

```

Finish a record.

```{r}

finish_log()

```

