---
title: "Effect of age and light on the volatile profile of *Ilex guayusa* leaves - Univariate statistical analysis"
author: "Jefferson Pastu√±a"
date: "2024-04-17"
output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
usethis::git_vaccinate()

```

# Introduction

This R Script aims to record the procedure for analyzing the volatile profile of *Ilex guayusa* leaves under different age and light conditions. Each step has a brief explanation, as well as code and graphics.

The previous preprocessed data in the [multivariate statistics notebook](https://doi.org/10.3390/metabo10040135) will be used here.

# Volcano plot

The generalized logarithm (glog) transformed data and the PQN normalized data were used for volcano plot analysis. The two-sample t-test method (was calculated using glog transformed data) was used for the "y" axis of the volcano plot, and fold change (was calculated using PQN normalized data) was used for the "x" axis. We plotted two volcanoes, one with SubQC data and the other with individual data.

The first step was data extraction.

## SubQC

SubQC data extraction for t-test calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of sample group from the dataset
volc_glog <- glog_set[, glog_set$Analysis_group != "Sample"]
pData(volc_glog) <- droplevels(pData(volc_glog))
# Drop QC
volc_glog <- drop_qcs(volc_glog)
# Extracting SubQC light factor
volc_glog <- volc_glog[, volc_glog$Light_factor != "Other factor"]
pData(volc_glog) <- droplevels(pData(volc_glog))

```

SubQC data extraction for fold change calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of sample group from the dataset
volc_pqn <- ppm_noflag[, ppm_noflag$Analysis_group != "Sample"]
pData(volc_pqn) <- droplevels(pData(volc_pqn))
# Drop QC
volc_pqn <- drop_qcs(volc_pqn)
# Extracting SubQC light factor
volc_pqn <- volc_pqn[, volc_pqn$Light_factor != "Other factor"]
pData(volc_pqn) <- droplevels(pData(volc_pqn))

```

Calculation of t-test and fold change.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Fold change between shade and light levels
volc_fc <- fold_change(volc_pqn, group = "Light_factor")
# two-sample t-test performing
volc_t <- perform_t_test(volc_glog, formula_char = "Feature ~ Light_factor")
# Adding the fold change to the t-test data
volc_data <- left_join(volc_t, volc_fc)
# Log-transform for visualization
volc_data$logP <- -log10(volc_data$Light_vs_Shade_t_test_P)
volc_data$log2_fc <- log2(volc_data$Shade_vs_Light_FC)

```

Volcano plot of SubQC.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 9, fig.height = 15}

# Determine point colors based on significance and fold change
volc_data <- volc_data %>%
  mutate(point_color = case_when(
    Light_vs_Shade_t_test_P < 0.05 & log2_fc < -1 ~ "Down", # significantly down
    Light_vs_Shade_t_test_P < 0.05 & log2_fc > 1 ~ "Up",    # significantly up
    log2_fc < 1 & log2_fc > -1 ~ "No fold change",          # fold change < 2
    Light_vs_Shade_t_test_P > 0.05 & log2_fc < -1 | 
      Light_vs_Shade_t_test_P > 0.05 & log2_fc > 1 ~ "Fold change")) # fold change > 2
# Creating a new small table of the annotated compounds
## Keep metabolites with p-value < 0.05
volc_compouds <- subset(volc_data, Light_vs_Shade_t_test_P < 0.05 |
                             point_color == "Fold change")
volc_compouds <- left_join(meta_table, volc_compouds)
# Volcano plot
vc_plot <- ggplot(volc_data, aes(log2_fc, logP, color = point_color)) +
  geom_point(size = 2, alpha = 0.4) +
  scale_colour_manual(values = c("No fold change" = "#808080",
                                 "Down" = "#4F9D4EFF",
                                 "Up" = "#ff80ff",
                                 "Fold change" = "#F5BC5CFF")) +
  theme_classic() +
  #theme(legend.position = "none") +
  #geom_point(data = volc_compouds,
  #           aes(shape = meta_table$Identification_level,
  #               color = meta_table$Identification_level),
  #           size = 2) +
  labs(#shape = 'Identification level',
       color = 'Color key') +
  ggrepel::geom_label_repel(data = volc_compouds,
                            aes(label = meta_table$Metabolite),
                            color = "black",
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 20,
                            min.segment.length = 0,
                            seed = 42,) +
  xlab(bquote(Log[2](Shade/Light))) + ylab(bquote(-Log[10](p-value))) +
  scale_y_continuous(limits = c(0,4), labels = function(i) 10^-i,
                     expand=c(0.003, 0.003)) +
  theme(legend.position = c(0.90, 0.947),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  #geom_vline(xintercept = 1, linetype = "longdash", colour="gray") +
  #geom_vline(xintercept = -1, linetype = "longdash", colour="gray") +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = -log10(0.05), linetype = "longdash", colour="gray")
vc_plot
# Save plot
#ggsave('Result/notame_Result/figure_2b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

## Sample

Sample data extraction for t-test calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of sample group from the dataset
sp_volc_glog <- glog_set[, glog_set$Analysis_group != "Sub_Quality_Control"]
pData(sp_volc_glog) <- droplevels(pData(sp_volc_glog))
# Drop QC
sp_volc_glog <- drop_qcs(sp_volc_glog)

```

Sample data extraction for fold change calculation.

```{r echo=TRUE, message=TRUE, warning=FALSE, error=FALSE}

# Removal of sample group from the dataset
sp_volc_pqn <- ppm_noflag[, ppm_noflag$Analysis_group != "Sub_Quality_Control"]
pData(sp_volc_pqn) <- droplevels(pData(sp_volc_pqn))
# Drop QC
sp_volc_pqn <- drop_qcs(sp_volc_pqn)

```

Calculation of t-test and fold change.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Fold change between shade and light levels
sp_volc_fc <- fold_change(sp_volc_pqn, group = "Light_factor")
# two-sample t-test performing
sp_volc_t <- perform_t_test(sp_volc_glog,
                            formula_char = "Feature ~ Light_factor")
# Adding the fold change to the t-test data
sp_volc_data <- left_join(sp_volc_t, sp_volc_fc)
# Log-transform for visualization
sp_volc_data$logP <- -log10(sp_volc_data$Light_vs_Shade_t_test_P)
sp_volc_data$log2_fc <- log2(sp_volc_data$Shade_vs_Light_FC)

```

Volcano plot of Sample.

```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.width = 9, fig.height = 15}

# Determine point colors based on significance and fold change
sp_volc_data <- sp_volc_data %>%
  mutate(point_color = case_when(
    Light_vs_Shade_t_test_P < 0.05 & log2_fc < -1 ~ "Down", # significantly down
    Light_vs_Shade_t_test_P < 0.05 & log2_fc > 1 ~ "Up",    # significantly up
    log2_fc < 1 & log2_fc > -1 ~ "No fold change",          # fold change < 2
    Light_vs_Shade_t_test_P > 0.05 & log2_fc < -1 | 
      Light_vs_Shade_t_test_P > 0.05 & log2_fc > 1 ~ "Fold change")) # fold change > 2
# Creating a new small table of the annotated compounds
## Keep metabolites with p-value < 0.05
sp_volc_compouds <- subset(sp_volc_data, Light_vs_Shade_t_test_P < 0.05 |
                             point_color == "Fold change")
sp_volc_compouds <- left_join(meta_table, sp_volc_compouds)
# Volcano plot
sp_vc_plot <- ggplot(sp_volc_data, aes(log2_fc, logP, color = point_color)) +
  geom_point(size = 2, alpha = 0.4) +
  scale_colour_manual(values = c("No fold change" = "#808080",
                                 "Down" = "#4F9D4EFF",
                                 "Up" = "#ff80ff",
                                 "Fold change" = "#F5BC5CFF")) +
  theme_classic() +
  #theme(legend.position = "none") +
  #geom_point(data = volc_compouds,
  #           aes(shape = meta_table$Identification_level,
  #               color = meta_table$Identification_level),
  #           size = 2) +
  labs(#shape = 'Identification level',
       color = 'Color key') +
  ggrepel::geom_label_repel(data = sp_volc_compouds,
                            aes(label = meta_table$Metabolite),
                            color = "black",
                            box.padding = 0.37,
                            label.padding = 0.22,
                            label.r = 0.30,
                            cex = 2.5,
                            max.overlaps = 20,
                            min.segment.length = 0,
                            seed = 42,) +
  xlab(bquote(Log[2](Shade/Light))) + ylab(bquote(-Log[10](p-value))) +
  scale_y_continuous(limits = c(0,4), labels = function(i) 10^-i,
                     expand=c(0.003, 0.003)) +
  theme(legend.position = c(0.90, 0.947),
        legend.background = element_rect(fill = "white", color = "black")) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill= "transparent")) +
  #geom_vline(xintercept = 1, linetype = "longdash", colour="gray") +
  #geom_vline(xintercept = -1, linetype = "longdash", colour="gray") +
  geom_vline(xintercept = 0, linetype = "longdash", colour="gray") +
  geom_hline(yintercept = -log10(0.05), linetype = "longdash", colour="gray")
sp_vc_plot
# Save plot
#ggsave('Result/notame_Result/figure_2b.pdf',
#       width = 5, height = 4, device='pdf', dpi="print")

```

# Tukey Test

XXXXX

## SubQC

XXXXX

## Sample

XXXX








Finish a record.

```{r}

finish_log()

```



