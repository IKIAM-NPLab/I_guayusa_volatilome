---
title: "Spectral_Deconvolution"
author: Edison Gonzales, Jefferson Pastuna"
date: "2024-06-09"
output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
usethis::git_vaccinate()

```

### Introduction

Metabolomics has been driven by mass spectrometry technologies such as gas chromatography coupled to mass spectrometry (GC-MS), allowing it to take an important role in recent years. However, it has been facing challenges in the identification and quantification of metabolites due to the coelution of complex samples and fragmentation of ions, nevertheless, techniques have been developed that allow the analysis of GC-MS data such as "peak-picking" and multivariate deconvolution.(Domingo-Almenara et al., 2016)
Tools such as MZmine, MetAlign and XCMS are used for data processing, but their focus on m/z values and fragmented peak areas makes accurate compound identification difficult. On the other hand, TNO-DECO and ADAP-GC focus on quantification and identification of metabolites from raw data.(Domingo-Almenara et al., 2016)
Therefore, based on the limitations and parameters to be followed, software has been developed that allows a comprehensive and accurate analysis of the data. These include eRah, a free and open source software designed to process data in untargeted GC-MS-based metabolomics. This R package is based on central deconvolution, focusing on blind source separation (BSS), quantification and automated identification of sample spectra by comparison with spectral libraries.(Domingo-Almenara et al., 2016)

### Before to start
eRah is a free R package which incorporates a central deconvolution method, so it uses multivariate techniques based on blind source separation (BSS) which is a process that allows the alignment, quantification and identification of metabolites through the comparison of spectral libraries, which in turn, allows obtaining a table with the names of the compounds, the matching scores and the integrated area of the compound for each sample.
The table shows the compound names, coincidence scores and the integrated area of the compound for each sample.

### eRah package workflow
The eRah package is installed and loaded, using "lirary (erah)".


```{r echo=TRUE, message=FALSE, warning=FALSE}

# eRah package installation
#install.packages('erah')
# eRah library call
library(erah)
```

Delete unwanted files in a specific directory and create a directory with the desired files. 


```{r echo=TRUE}

# Delete all file that are not in folders
unlink('Data/Data_to_eRah/*')
# Data folder path
createdt('Data/Data_to_eRah/')

```

Data from two CSV files is loaded and processed, creating an experiment object containing this data, tagged with relevant information for the study of the volatilloma of I. guayusa.


```{r echo=TRUE}

# Loading (*.mzXML) chromatograms
#phenotype <- read.csv('Data/Metadata_to_eRah/Metadata_pheno_mzXML.csv')
# If (*.mzXML) did not work
# Loading (*.CDF) chromatograms
instrumental <- read.csv('Data/Metadata_to_eRah/Metadata_inst_CDF.csv')
# Merge of metadata information with chromatograms
raw_data <- newExp(instrumental = instrumental,
                   phenotype = phenotype,
                   info = 'I. guayusa volatilome')

```

Parameters for composite deconvolution are specified, defining specific criteria on peak width and minimum height, noise threshold, and excluding certain ranges of m/z values from processing to improve the accuracy and relevance of chemical analysis.


```{r echo=TRUE}

dec_par <- setDecPar(min.peak.width = 3,
                     min.peak.height = 500,
                     noise.threshold = 50,
                     avoid.processing.mz = c(50:69,73:75,147:149))

```

To carry out a process in parallel we use the "future" package, which allows us to execute tasks in parallel, improving efficiency and processing speed simultaneously.

```{r echo=TRUE}

plan(future::multisession,
     workers = 15)

```

We proceed to the deconvolution of compounds in the experimental data (raw_data) using the parameters specified in "dec_par" the results obtained will be saved in (dec_par).


```{r echo=TRUE, warning=FALSE}

dec_data <- deconvolveComp(raw_data,
                           dec_par)

```
Parameters are defined for alignment and applied to the data.


```{r echo=TRUE}

# Alignment parameters
alig_par <- setAlPar(min.spectra.cor = 0.9,
                     max.time.dist = 3,
                     mz.range = 50:500)
# Alignment
peak_alig <- alignComp(dec_data,
                       alParameters = alig_par)

```

By means of the "recMissComp" function it is used to recover missing compounds in spectral data, which allows the general model to be adjusted to the compounds present in a minimum number of samples and can consider the spectra of samples where the compound is missing to obtain the final average spectrum.


```{r echo=TRUE, warning=FALSE}

peak_find <- recMissComp(peak_alig,
                         min.samples = 3)

```

Identification

```{r echo=TRUE, warning=FALSE}

# Loading NIST 20 (*.msp) library
#nist.database <- importMSP(filename = "E:/NIST_20_Library/Result/NIST20EI_2eRah.MSP",
#                           DB.name = "NIST",
#                           DB.version = "NIST20",
#                           DB.info = "NIST MS Search Export")
# Save library for a posterior faster loading
#save(nist.database, file= "E:/NIST_20_Library/Result/NIST20EI_2eRah.rda")
# Load R library
load("E:/NIST_20_Library/Result/NIST20EI_2eRah.rda")
mslib <- nist.database
# Identification
peak_iden <- identifyComp(peak_find,
                          id.database = mslib,
                          mz.range = NULL,
                          n.putative = 20)
# Identified compound
id_list <- idList(peak_iden)
# Exporting identified compounds
write.csv(id_list,
          file = "Result/eRah_Result/NIST_Identification.csv")

```

### Identification

How many metabolites were identified?

Mirror plot of identified compounds

```{r echo=TRUE}

plotSpectra(peak_iden, 1, 1, draw.color = "red")

```

Exporting spectra to NIST identification

```{r echo=TRUE}

export2MSP(peak_iden,
           store.path = "Result/eRah_Result",
           alg.version = 2)

```

