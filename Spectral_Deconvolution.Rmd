---
title: "Spectral_Deconvolution"
author: Edison Gonzales, Jefferson Pastuna"
date: "2024-06-09"
output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
usethis::git_vaccinate()

```

### Introduction

En los últimos años se han venido desarrollado tecnologías basadas en espectrometría de masas que han permitido dar un auge a la metabolómica, un ejemplo claro es la cromatografía gaseosa acoplada a espectrometría de masas GC-MS, técnica que permite el análisis de metabos de sustancias volátiles y semi volátiles. La base dicha técnica es la ionización a partir de 70v. 
Este proceso de ionización en GC es altamente reproducible sin embargo la coelución de muestras complejas junto a la extensa fragmentación de iones da como resultado un conjunto de datos grandes y complejos, unido también a la falta de herramientas computacionales integradas a la metabolómica no dirigida en GC-MS dificulta en gran medida en la identificación y cuantificación de metabolitos. 
El análisis de datos de GC-MS se divide en dos categorías principales, la primera es “peak-picking”, que implica la desconvolución para fragmentar e identificar los picos más relevantes en los espectros entre diferentes muestras, permitiéndonos descubrir variaciones estadísticas en los picos entre grupos experimentales. Las herramientas que permiten este tipo de procesamiento de datos son MZmine,MetAligny XCMS. Sin embargo, estos métodos no se basan en los espectros de los compuestos, sino en el valor m/z el tiempo de retención y el área de los picos de iones fragmentados. Lo que ocasiona dificultad en la identificación de los compuestos. 
La segunda categoría se basa en la cuantificación e identificación mediante procesos de descovolucion multivariable que extrae y construye compuestos puros a partir de datos brutos. Las herramientas aplicadas para este proceso son TNO-DECO o ADAP-GC. De igual forma existen sofwares libres como AMDIS or BinBase cada uno de estos sofwares representan limitaciones especificas que impide un análisis amplio de la data obtenida por medio del GC-MS.
Por ende, a base de las limitaciones y parámetros a seguir, se han desarrollado softwares que permiten un análisis amplio y preciso de los datos. Entre ellos destaca eRah, un software gratuito y de código abierto diseñado para procesar datos en metabolómica no dirigida basada en GC-MS. Este paquete de R se basa en la deconvolución central, centrándose principalmente en la separación ciega de fuentes (BSS), la cuantificación y la identificación automatizada de espectros de muestra mediante la comparación con bibliotecas espectrales.

### Before to start
eRah, es un paquete de R gratuito el cual incorpora un método de deconvulcion central, de modo que utiliza técnicas multivariadas las cuales se basan en la separación ciega de fuentes  (BSS) el cual es un proceso que permite la alineación, cuantificación y la identificación de metabolitos a través de la comparación de bibliotecas espectrales, lo que a su vez, permite la obtención de una tabla con los nombres de los compuestos, las puntuaciones de coincidencia y el área integrada del compuesto para cada muestra.

### eRah package workflow
Se procede a instalar y cargar el paquete eRah, usando  "lirary (erah)"


```{r echo=TRUE, message=FALSE, warning=FALSE}

# eRah package installation
#install.packages('erah')
# eRah library call
library(erah)
```

Acontinuamos eliminar archivos no deseados en un directorio especifico y creando un directorio con los archivos deceados, organizando asi nuestro espacio de trabajo. 


```{r echo=TRUE}

# Delete all file that are not in folders
unlink('Data/Data_to_eRah/*')
# Data folder path
createdt('Data/Data_to_eRah/')

```

Se procede a cargar y procesar datos de dos archivos CSV, creando un objeto de experimento que contiene estos datos, etiquetado con información relevante para el estudio del volatiloma de I. guayusa.


```{r echo=TRUE}

instrumental <- read.csv('Data/Metadata_to_eRah/Metadata_inst.csv')
phenotype <- read.csv('Data/Metadata_to_eRah/Metadata_pheno.csv')

raw_data <- newExp(instrumental = instrumental,
                   phenotype = phenotype,
                   info = 'I. guayusa volatilome')

```

Se especifica los parámetros para la desconvolución de compuestos, definiendo criterios específicos sobre el ancho y la altura mínima de los picos, el umbral de ruido y excluyendo ciertos rangos de valores m/z del procesamiento para mejorar la precisión y relevancia del análisis químico.

```{r echo=TRUE}

dec_par <- setDecPar(min.peak.width = 3,
                     min.peak.height = 500,
                     noise.threshold = 50,
                     avoid.processing.mz = c(50:69,73:75,147:149))

```

Para realizar un proceso en paralelo usamos el paquete "future", el cual permite ejecutar tareas en paralelo,mejorando eficiencia y velocidad de procesamiento de forma simultanea. 

```{r echo=TRUE}

plan(future::multisession,
     workers = 14)

```

Deconvolution

```{r echo=TRUE, warning=FALSE}

dec_data <- deconvolveComp(raw_data,
                           dec_par)

```

Alignment

```{r echo=TRUE}

# Alignment parameters
alig_par <- setAlPar(min.spectra.cor = 0.9,
                     max.time.dist = 3,
                     mz.range = 50:500)
# Alignment
peak_alig <- alignComp(dec_data,
                       alParameters = alig_par)

```

Missing compound recovery

```{r echo=TRUE, warning=FALSE}

peak_find <- recMissComp(peak_alig,
                         min.samples = 3)

```

Identification

```{r echo=TRUE, warning=FALSE}

# Loading NIST 20 (*.msp) library
nist.database <- importMSP(filename = "E:/NIST_20_Library/Result/NIST20EI_2eRah.MSP",
                           DB.name = "NIST",
                           DB.version = "NIST20",
                           DB.info = "NIST MS Search Export")
# Save library for a posterior faster loading
save(nist.database, file= "E:/NIST_20_Library/Result/NIST20EI_2eRah.rda")
# Load R library
load("E:/NIST_20_Library/Result/NIST20EI_2eRah.rda")
mslib <- nist.database
# Identification
peak_iden <- identifyComp(peak_find,
                          id.database = mslib,
                          mz.range = NULL,
                          n.putative = 20)
# Identified compound
id_list <- idList(peak_iden)
# Exporting identified compounds
write.csv(id_list,
          file = "Result/eRah_Result/NIST_Identification.csv")

```

Mirror plot of identified compounds

```{r echo=TRUE}

plotSpectra(peak_iden, 1, 1, draw.color = "red")

```

Exporting spectra to NIST identification

```{r echo=TRUE}

export2MSP(peak_iden,
           store.path = "Result/eRah_Result",
           alg.version = 2)

```

