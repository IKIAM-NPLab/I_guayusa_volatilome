---
title: "Spectral_Deconvolution"
author: "Edison Gonzales, Jefferson Pastuna"
date: "2024-06-09"
output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
usethis::git_vaccinate()

```

# Introduction

Metabolomics has been driven by mass spectrometry technologies such as gas chromatography coupled to mass spectrometry (GC-MS), allowing it to take an important role in recent years. However, it has been facing challenges in the identification and quantification of metabolites due to the coelution of complex samples and fragmentation of ions, nevertheless, techniques have been developed that allow the analysis of GC-MS data such as "peak-picking" and multivariate deconvolution.(Domingo-Almenara et al., 2016)
Tools such as MZmine, MetAlign and XCMS are used for data processing, but their focus on m/z values and fragmented peak areas makes accurate compound identification difficult. On the other hand, TNO-DECO and ADAP-GC focus on quantification and identification of metabolites from raw data.(Domingo-Almenara et al., 2016)
Therefore, based on the limitations and parameters to be followed, software has been developed that allows a comprehensive and accurate analysis of the data. These include eRah, a free and open source software designed to process data in untargeted GC-MS-based metabolomics. This R package is based on central deconvolution, focusing on blind source separation (BSS), quantification and automated identification of sample spectra by comparison with spectral libraries.(Domingo-Almenara et al., 2016)

# Before to start
eRah is a free R package which incorporates a central deconvolution method, so it uses multivariate techniques based on blind source separation (BSS) which is a process that allows the alignment, quantification and identification of metabolites through the comparison of spectral libraries, which in turn, allows obtaining a table with the names of the compounds, the matching scores and the integrated area of the compound for each sample.
The table shows the compound names, coincidence scores and the integrated area of the compound for each sample.

# eRah package workflow

The eRah package is installed and loaded, using "lirary (erah)".

```{r echo=TRUE, message=FALSE, warning=FALSE}

# eRah package installation
#install.packages('erah')
# eRah library call
library(erah)
```

Delete unwanted files in a specific directory and create a directory with the desired files. 

```{r echo=TRUE}

# Delete all file that are not in folders
unlink('Data/Data_to_eRah/*')
# Data folder path
createdt('Data/Data_to_eRah/')

```

Data from two CSV files is loaded and processed, creating an experiment object containing this data, tagged with relevant information for the study of the volatilloma of I. guayusa.

```{r echo=TRUE}

# Loading (*.mzXML) chromatograms
#instrumental <- read.csv('Data/Metadata_to_eRah/Metadata_inst_mzXML.csv')
# If (*.mzXML) did not work
# Loading (*.CDF) chromatograms
instrumental <- read.csv('Data/Metadata_to_eRah/Metadata_inst_CDF.csv')
# Loading metadata of the chromatograms
phenotype <- read.csv('Data/Metadata_to_eRah/Metadata_pheno.csv')
# Merge of metadata information with chromatograms
raw_data <- newExp(instrumental = instrumental,
                   phenotype = phenotype,
                   info = 'I. guayusa volatilome')

```

Parameters for composite deconvolution are specified, defining specific criteria on peak width and minimum height, noise threshold, and excluding certain ranges of m/z values from processing to improve the accuracy and relevance of chemical analysis.

## Compound Deconvolution

```{r echo=TRUE}

dec_par <- setDecPar(min.peak.width = 3,
                     min.peak.height = 500,
                     noise.threshold = 50,
                     avoid.processing.mz = c(50:69,73:75,147:149),
                     analysis.time = c(3.1,50))

```

To carry out a process in parallel we use the "future" package, which allows us to execute tasks in parallel, improving efficiency and processing speed simultaneously.

```{r echo=TRUE}

plan(future::multisession,
     workers = 14)

```

We proceed to the deconvolution of compounds in the experimental data (raw_data) using the parameters specified in "dec_par" the results obtained will be saved in (dec_par).


```{r echo=TRUE, warning=FALSE}

dec_data <- deconvolveComp(raw_data,
                           dec_par)

```

## Alignment

Parameters are defined for alignment and applied to the data.

```{r echo=TRUE}

# Alignment parameters
alig_par <- setAlPar(min.spectra.cor = 0.9,
                     max.time.dist = 5,
                     mz.range = 50:500)
# Alignment
peak_alig <- alignComp(dec_data,
                       alParameters = alig_par)

```

## Missing Compound Recovery

By means of the "recMissComp" function it is used to recover missing compounds in spectral data, which allows the general model to be adjusted to the compounds present in a minimum number of samples and can consider the spectra of samples where the compound is missing to obtain the final average spectrum.


```{r echo=TRUE, warning=FALSE}

peak_find <- recMissComp(peak_alig,
                         min.samples = 3)

```

# Identification

```{r echo=TRUE, warning=FALSE}

# Loading NIST 20 (*.msp) library
#nist.database <- importMSP(filename = "E:/NIST_20_Library/Result/NIST20EI_2eRah.MSP",
#                           DB.name = "NIST",
#                           DB.version = "NIST20",
#                           DB.info = "NIST MS Search Export")
# Save library for a posterior faster loading
#save(nist.database, file= "E:/NIST_20_Library/Result/NIST20EI_2eRah.rda")
# Load R library
load("E:/NIST_20_Library/Result/NIST20EI_2eRah.rda")
mslib <- nist.database
# Identification
peak_iden <- identifyComp(peak_find,
                          id.database = mslib,
                          mz.range = NULL,
                          n.putative = 100)
# Identified compounds list
id_list <- idList(peak_iden)
# Exporting identified compounds list
#write.csv(id_list,
#          file = "Result/eRah_Result/NIST_Identification.csv")

```

Exporting spectra to NIST identification.

```{r echo=TRUE}

export2MSP(peak_iden,
           store.path = "Result/eRah_Result",
           alg.version = 2)

```

## Cleaning the identification list

How many metabolites were identified?
How we are clean the identified compound list?

Installation of R package to calculate linear retention index (RI).

```{r echo=TRUE}

# Installation of "MetaboCoreUtils" package
#install.packages("remotes")
#remotes::install_github("rformassspectrometry/MetaboCoreUtils")

# Loading "MetaboCoreUtils" library
library("MetaboCoreUtils")

```

Explain how retention time of n-alkanes was extract?

Read of retention time list of n-alkanes

```{r echo=TRUE}

# Loadding rt of each n-alkane
rti <- data.frame(rtime = c(7.557, 10.006, 12.569, 15.111, 17.581, 19.937,
                            22.190, 24.338, 26.399, 28.813, 32.000, 36.327,
                            39.949, 42.506, 44.557, 46.309, 47.852, 49.257,
                            50.554, 51.781, 52.936, 54.182, 55.604),
                  rindex = c(1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800,
                             1900, 2000, 2100, 2200, 2300, 2400, 2500, 2600,
                             2700, 2800, 2900, 3000, 3100, 3200, 3300))

```

Peak of AlignID number 1

```{r echo=TRUE}

plotProfile(peak_iden, 1)
# Visual inspection:
# Low quality peak

```

Peak of AlignID number 2

```{r echo=TRUE}

plotProfile(peak_iden, 2)
# Visual inspection:
# Low quality peak

```

Peak of AlignID number 3

```{r echo=TRUE}

plotProfile(peak_iden, 3)
# Visual inspection:
# Low quality peak

```

Peak of AlignID number 4

```{r echo=TRUE}

plotProfile(peak_iden, 4)
# Visual inspection:
# Low quality peak

```

Peak of AlignID number 5

```{r echo=TRUE}

plotProfile(peak_iden, 5)
# Visual inspection:
# Low quality peak

```

### 2-Butenoic acid, 3-methyl-

Peak of AlignID number 7

```{r echo=TRUE}

plotProfile(peak_iden, 7)
# Visual inspection:
# Good peak shape

```

Mirror plot of  alignID number 7

```{r echo=TRUE}

plotSpectra(peak_iden, 7,
            draw.color = "red",
            comp.db = 294996,
            xlim = c(50,140))
# Experimental RI = 959 (Calculated by GCMSsolution software)
# Literature RI = 953 (NIST#: 230321)
# ΔRI = 6

```

Peak of AlignID number 8

```{r echo=TRUE}

plotProfile(peak_iden, 8)
# Visual inspection:
# Good peak shape

```

Mirror plot of  alignID number 8

```{r echo=TRUE}

plotSpectra(peak_iden, 8, 1,
            draw.color = "red",
            xlim = c(50,150))
# Experimental RI = 968 (Calculated by GCMSsolution software)
# Literature RI = 759 (NIST#: 292995)
# ΔRI = 209 (High RI)

```

Peak of AlignID number 9

```{r echo=TRUE}

plotProfile(peak_iden, 9)
# Visual inspection:
# Good peak shape

```

Mirror plot of  alignID number 9

```{r echo=TRUE}

plotSpectra(peak_iden, 9,
            draw.color = "red",
            comp.db = 294996,
            xlim = c(50,140))
# Experimental RI = 959 (Calculated by GCMSsolution software)
# Literature RI = 953 (NIST#: 230321)
# ΔRI = 6

```

### 2(5H)-Furanone, 3-methyl-

Peak of AlignID number 10

```{r echo=TRUE}

plotProfile(peak_iden, 10)
# Visual inspection:
# Good peak shape

```

Mirror plot of  alignID number 10

```{r echo=TRUE}

plotSpectra(peak_iden, 10, 36,
            draw.color = "red",
            xlim = c(50,150))
# Experimental RI = 968 (Calculated by GCMSsolution software)
# Literature RI = 983 (NIST#: 156505)
# ΔRI = 15

```

Peak of AlignID number 11

```{r echo=TRUE}

plotProfile(peak_iden, 11)
# Visual inspection:
# Low quality peak

```

Peak of AlignID number 12

```{r echo=TRUE}

plotProfile(peak_iden, 12)
# Visual inspection:
# Low quality peak

```

Peak of AlignID number 13

```{r echo=TRUE}

plotProfile(peak_iden, 13)
# Visual inspection:
# Good peak shape

```



